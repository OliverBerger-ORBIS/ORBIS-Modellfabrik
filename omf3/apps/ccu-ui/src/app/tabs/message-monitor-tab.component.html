<section class="message-monitor-tab">
  <header class="monitor-header">
    <img [src]="monitorHeadingIcon" alt="Message Monitor icon" />
    <div>
      <h2 i18n="@@messageMonitorHeading">Message Monitor</h2>
      <p i18n="@@messageMonitorSubheading">Real-time MQTT message monitoring and history</p>
      <small class="monitor-header__environment">
        <span i18n="@@messageMonitorEnvironment">Environment</span>: {{ environmentLabel }}
      </small>
    </div>
  </header>

  <div class="monitor-controls">
    <div class="filter-group">
      <h3 i18n="@@messageMonitorFilters">Filters</h3>
      <div class="filter-inputs">
        <label>
          <span i18n="@@messageMonitorFilterText">Topic search</span>
          <input 
            type="text" 
            [(ngModel)]="filterText" 
            placeholder="Filter by topic name..."
            i18n-placeholder="@@messageMonitorFilterTextPlaceholder"
          />
        </label>
        
        <label>
          <span i18n="@@messageMonitorFilterModule">Module/Serial filter</span>
          <input 
            type="text" 
            [(ngModel)]="filterModule" 
            placeholder="e.g., SVR3QA0022, 5iO4..."
            i18n-placeholder="@@messageMonitorFilterModulePlaceholder"
          />
        </label>
        
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            [(ngModel)]="filterConnectionState"
          />
          <span i18n="@@messageMonitorFilterConnectionState">Show only connection/state topics</span>
        </label>
      </div>
      
      <div class="filter-actions">
        <button type="button" class="btn-secondary" (click)="clearFilters()">
          <span i18n="@@messageMonitorClearFilters">Clear Filters</span>
        </button>
        <button type="button" class="btn-danger" (click)="clearAllData()">
          <span i18n="@@messageMonitorClearAll">Clear All Data</span>
        </button>
      </div>
    </div>
  </div>

  <div class="monitor-content">
    <aside class="topics-panel">
      <header class="panel-header">
        <h3 i18n="@@messageMonitorTopics">Topics</h3>
        <span class="topic-count" *ngIf="topics$ | async as topics">
          {{ topics.length }}
        </span>
      </header>
      
      <ul class="topics-list" *ngIf="topics$ | async as topics; else topicsLoading">
        <li 
          *ngFor="let topic of topics; trackBy: trackByTopic"
          class="topic-item"
          [class.selected]="topic.topic === selectedTopic"
          [class.invalid]="!topic.valid"
          (click)="selectTopic(topic.topic)"
        >
          <div class="topic-name">{{ topic.topic }}</div>
          <div class="topic-meta">
            <span class="message-count">{{ topic.messageCount }}</span>
            <span class="validity-indicator" [class.valid]="topic.valid" [class.invalid]="!topic.valid">
              {{ topic.valid ? '✓' : '✗' }}
            </span>
          </div>
        </li>
        
        <li *ngIf="topics.length === 0" class="empty-state" i18n="@@messageMonitorNoTopics">
          No topics found. Messages will appear here as they arrive.
        </li>
      </ul>
      
      <ng-template #topicsLoading>
        <div class="loading-state" i18n="@@messageMonitorLoadingTopics">Loading topics...</div>
      </ng-template>
    </aside>

    <main class="details-panel">
      <div *ngIf="selectedTopic; else noSelection" class="topic-details">
        <header class="details-header">
          <div>
            <h3>{{ selectedTopic }}</h3>
            <p class="retention-info">
              <span i18n="@@messageMonitorRetention">Retention</span>: 
              {{ getRetentionLimit() }} 
              <span i18n="@@messageMonitorMessages">messages</span>
            </p>
          </div>
          <button 
            type="button" 
            class="btn-danger-small" 
            (click)="clearTopicData()"
            i18n="@@messageMonitorClearTopic"
          >
            Clear Topic
          </button>
        </header>

        <div class="message-history">
          <h4 i18n="@@messageMonitorHistory">Message History</h4>
          <ul class="history-list">
            <li 
              *ngFor="let message of messageHistory; trackBy: trackByMessage"
              class="history-item"
              [class.selected]="message === selectedMessage"
              [class.invalid]="!message.valid"
              (click)="selectMessage(message)"
            >
              <span class="timestamp">{{ formatTimestamp(message.timestamp) }}</span>
              <span class="validity" [class.valid]="message.valid" [class.invalid]="!message.valid">
                {{ message.valid ? '✓' : '✗' }}
              </span>
            </li>
            
            <li *ngIf="messageHistory.length === 0" class="empty-state" i18n="@@messageMonitorNoHistory">
              No messages in history for this topic.
            </li>
          </ul>
        </div>

        <div class="message-payload" *ngIf="selectedMessage">
          <header class="payload-header">
            <h4 i18n="@@messageMonitorPayload">Message Payload</h4>
            <div class="payload-meta">
              <span class="timestamp">{{ formatTimestamp(selectedMessage.timestamp) }}</span>
              <span 
                class="validity-badge" 
                [class.valid]="selectedMessage.valid" 
                [class.invalid]="!selectedMessage.valid"
              >
                <ng-container *ngIf="selectedMessage.valid; else invalidBadge" i18n="@@messageMonitorValidPayload">Valid</ng-container>
                <ng-template #invalidBadge><span i18n="@@messageMonitorInvalidPayload">Invalid</span></ng-template>
              </span>
            </div>
          </header>
          
          <div 
            *ngIf="!selectedMessage.valid && selectedMessage.validationErrors" 
            class="validation-errors"
          >
            <h5 i18n="@@messageMonitorValidationErrors">Validation Errors:</h5>
            <ul>
              <li *ngFor="let error of selectedMessage.validationErrors">{{ error }}</li>
            </ul>
          </div>
          
          <pre class="payload-json"><code>{{ formatJsonPayload(selectedMessage.payload) }}</code></pre>
        </div>
      </div>

      <ng-template #noSelection>
        <div class="no-selection">
          <p i18n="@@messageMonitorSelectTopic">Select a topic from the list to view its messages and payloads.</p>
        </div>
      </ng-template>
    </main>
  </div>
</section>
