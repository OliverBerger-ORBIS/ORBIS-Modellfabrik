<section class="message-monitor-tab">
  <header class="monitor-header">
    <img [src]="monitorHeadingIcon" alt="Message Monitor icon" />
    <div>
      <h2 i18n="@@messageMonitorHeading">Message Monitor</h2>
      <p i18n="@@messageMonitorSubheading">Real-time MQTT message monitoring and history</p>
      <small class="monitor-header__environment">
        <span i18n="@@messageMonitorEnvironment">Environment</span>: {{ environmentLabel }}
      </small>
    </div>
  </header>

  <div class="monitor-controls">
    <div class="filter-group">
      <h3 i18n="@@messageMonitorFilters">Filters</h3>
      <div class="filter-inputs">
        <label>
          <span i18n="@@messageMonitorFilterTopicType">Topic Type</span>
          <select 
            [(ngModel)]="filterTopicType" 
            (ngModelChange)="onTopicTypeChange()"
            class="filter-select"
          >
            <option value="all" i18n="@@messageMonitorFilterAllTopics">All Topics</option>
            <option value="ccu" i18n="@@messageMonitorFilterCcuTopics">CCU Topics</option>
            <option value="module-fts" i18n="@@messageMonitorFilterModuleFtsTopics">Module/AGV Topics</option>
          </select>
        </label>

        <label *ngIf="filterTopicType === 'module-fts'">
          <span i18n="@@messageMonitorFilterModuleFts">Module/AGV Filter</span>
          <select 
            [(ngModel)]="filterModule" 
            (ngModelChange)="onFilterChange()"
            class="filter-select"
          >
            <option value="" i18n="@@messageMonitorFilterAllModules">All Modules/AGV</option>
            <option *ngFor="let module of availableModules" [value]="module.serial">
              {{ module.name }}
            </option>
          </select>
        </label>

        <label *ngIf="filterTopicType === 'module-fts'">
          <span i18n="@@messageMonitorFilterStatus">Status Filter</span>
          <select 
            [(ngModel)]="filterStatus" 
            (ngModelChange)="onFilterChange()"
            class="filter-select"
          >
            <option value="all" i18n="@@messageMonitorFilterAllStatus">All Status</option>
            <option value="connection" i18n="@@messageMonitorFilterConnection">Connection</option>
            <option value="state" i18n="@@messageMonitorFilterState">State</option>
            <option value="factsheet" i18n="@@messageMonitorFilterFactsheet">Factsheet</option>
          </select>
        </label>
        
        <label>
          <span i18n="@@messageMonitorFilterText">Topic search</span>
          <input 
            type="text" 
            [(ngModel)]="filterText" 
            (ngModelChange)="onFilterChange()"
            placeholder="Filter by topic name..."
            i18n-placeholder="@@messageMonitorFilterTextPlaceholder"
          />
        </label>
      </div>
      
      <div class="filter-actions">
        <button type="button" class="btn-secondary" (click)="clearFilters()">
          <span i18n="@@messageMonitorClearFilters">Clear Filters</span>
        </button>
        <button type="button" class="btn-danger" (click)="clearAllData()">
          <span i18n="@@messageMonitorClearAll">Clear All Data</span>
        </button>
      </div>
    </div>
  </div>

  <div class="monitor-content">
    <div class="table-container" *ngIf="messages$ | async as messages; else messagesLoading">
      <table class="messages-table">
        <thead>
          <tr>
            <th i18n="@@messageMonitorColumnTopic">Topic</th>
            <th i18n="@@messageMonitorColumnName">Name</th>
            <th i18n="@@messageMonitorColumnTimestamp">Timestamp</th>
            <th i18n="@@messageMonitorColumnPayload">Payload</th>
          </tr>
        </thead>
        <tbody>
          <tr 
            *ngFor="let message of messages; trackBy: trackByMessage"
            [class.invalid]="!message.valid"
            (click)="selectMessage(message)"
            [class.selected]="selectedMessage === message"
          >
            <td class="topic-cell">
              <div class="topic-content">
                <div class="topic-name">{{ message.topic }}</div>
                <span 
                  class="validity-indicator" 
                  [class.valid]="message.valid" 
                  [class.invalid]="!message.valid"
                  [title]="message.valid ? getValidMessageTooltip() : getInvalidMessageTooltip()"
                >
                  {{ message.valid ? '✓' : '✗' }}
                </span>
              </div>
            </td>
            <td class="name-cell">
              <div class="name-content">
                <img 
                  [src]="getTopicName(message.topic).icon" 
                  [alt]="getTopicName(message.topic).name"
                  class="name-icon"
                  onerror="this.style.display='none'"
                />
                <span class="name-text">{{ getTopicName(message.topic).name }}</span>
              </div>
            </td>
            <td class="timestamp-cell">{{ formatTimestamp(message.timestamp) }}</td>
            <td class="payload-cell">
              <code class="payload-preview">{{ formatPayloadPreview(message.payload) }}</code>
            </td>
          </tr>
          
          <tr *ngIf="messages.length === 0">
            <td colspan="4" class="empty-state" i18n="@@messageMonitorNoMessages">
              No messages found. Messages will appear here as they arrive.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <ng-template #messagesLoading>
      <div class="loading-state" i18n="@@messageMonitorLoadingMessages">Loading messages...</div>
    </ng-template>

    <!-- Detailed payload view modal/panel when a message is selected -->
    <div class="payload-detail-panel" *ngIf="selectedMessage" (click)="closeDetailPanel()" (keyup.escape)="closeDetailPanel()" tabindex="0" role="dialog" aria-modal="true" aria-labelledby="payload-detail-title">
      <div class="payload-detail-content" (click)="$event.stopPropagation()" (keyup.escape)="closeDetailPanel()" tabindex="0">
        <header class="detail-header">
          <div>
            <h4 id="payload-detail-title">{{ selectedMessage.topic }}</h4>
            <p class="detail-timestamp">{{ formatTimestamp(selectedMessage.timestamp) }}</p>
          </div>
          <button type="button" class="close-btn" (click)="closeDetailPanel()" [attr.aria-label]="getCloseLabel()">×</button>
        </header>
        
        <div 
          *ngIf="!selectedMessage.valid && selectedMessage.validationErrors" 
          class="validation-errors"
        >
          <h5 i18n="@@messageMonitorValidationErrors">Validation Errors:</h5>
          <ul>
            <li *ngFor="let error of selectedMessage.validationErrors">{{ error }}</li>
          </ul>
        </div>
        
        <pre class="payload-json"><code #jsonCodeBlock class="language-json">{{ formatJsonPayload(selectedMessage.payload) }}</code></pre>
      </div>
    </div>
  </div>
</section>
