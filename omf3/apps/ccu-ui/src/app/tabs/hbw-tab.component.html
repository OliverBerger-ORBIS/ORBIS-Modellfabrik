<section class="hbw-tab">
  <header class="hbw-tab__toolbar">
    <div class="hbw-tab__title">
      <img [src]="headingIcon" alt="HBW" class="hbw-tab__icon" width="32" height="32" />
      <div>
        <h1>{{ headingTitle }}</h1>
        <p class="hbw-tab__subtitle">
          {{ headingSubtitle }}
        </p>
      </div>
    </div>
    <div class="hbw-tab__fixtures" *ngIf="isMockMode">
      <span class="badge" i18n="@@orderTabFixtureLabel">Fixture</span>
      <div class="fixture-switch">
        <button
          type="button"
          *ngFor="let fixture of fixtureOptions"
          [class.active]="fixture === activeFixture"
          (click)="loadFixture(fixture)"
        >
          {{ fixtureLabels[fixture] }}
        </button>
      </div>
      <div class="environment-hint" *ngIf="isReplayMode">
        <span i18n="@@hbwReplayHint">Using replay environment - HBW data from MQTT broker</span>
      </div>
    </div>
  </header>

  <div class="hbw-tab__content" *ngIf="hbwState$ | async as hbwState; else noData">
    <div class="hbw-tab__grid">
      <!-- Left Column: Status & Connection -->
      <div class="hbw-tab__column hbw-tab__column--left">
        <!-- Status Section -->
        <section class="hbw-tab__section status-section">
          <h2>
            <img [src]="statusIcon" alt="Status" class="section-icon-img" width="24" height="24" />
            <span i18n="@@hbwStatusHeading">Status</span>
            <span class="serial-badge">{{ hbwState.serialNumber }}</span>
          </h2>
          
          <div class="status-card">
            <div class="status-item">
              <span class="status-label">{{ labelConnection }}</span>
              <div class="status-value">
                <span class="status-badge" [class.online]="getConnectionStatus(hbwState) === 'ONLINE'" [class.offline]="getConnectionStatus(hbwState) === 'OFFLINE'">
                  <img [src]="getConnectionStatus(hbwState) === 'ONLINE' ? connectionOnlineIcon : connectionOfflineIcon" alt="" width="16" height="16" />
                  <span>{{ getConnectionStatus(hbwState) === 'ONLINE' ? statusOnline : statusOffline }}</span>
                </span>
              </div>
            </div>

            <div class="status-item">
              <span class="status-label">{{ labelAvailability }}</span>
              <div class="status-value">
                <span class="status-badge" 
                      [class.ready]="getAvailability(hbwState) === 'READY'" 
                      [class.busy]="getAvailability(hbwState) === 'BUSY'"
                      [class.error]="getAvailability(hbwState) === 'ERROR'">
                  <span>{{ getAvailability(hbwState) === 'READY' ? statusReady : (getAvailability(hbwState) === 'BUSY' ? statusBusy : statusError) }}</span>
                </span>
              </div>
            </div>

            <div class="status-item">
              <span class="status-label">{{ labelOrderId }}</span>
              <div class="status-value">
                <span class="order-id">{{ getOrderIdDisplay(hbwState.orderId) }}</span>
              </div>
            </div>

            <div class="status-item" *ngIf="getCurrentAction(hbwState) as action">
              <span class="status-label">{{ labelCurrentAction }}</span>
              <div class="status-value">
                <span class="action-badge" [class]="getStateClass(action.state)">
                  <span class="command">{{ action.command }}</span>
                  <span class="state">{{ getStateLabel(action.state) }}</span>
                </span>
              </div>
            </div>
          </div>
        </section>

        <!-- Storage Information Section -->
        <section class="hbw-tab__section storage-section">
          <h2>
            <img [src]="storageIcon" alt="Storage" class="section-icon-img" width="24" height="24" />
            <span>{{ labelStorageInfo }}</span>
          </h2>

          <div class="storage-card">
            <div class="storage-item">
              <span class="storage-label">{{ labelSlot }}</span>
              <div class="storage-value">
                <span class="slot-value">{{ getStorageSlot(hbwState) ?? labelNoSlot }}</span>
              </div>
            </div>

            <div class="storage-item">
              <span class="storage-label">{{ labelLevel }}</span>
              <div class="storage-value">
                <span class="level-value">{{ getStorageLevel(hbwState) ?? labelNoLevel }}</span>
              </div>
            </div>

            <div class="storage-item">
              <span class="storage-label">{{ labelWorkpieceId }}</span>
              <div class="storage-value">
                <span class="workpiece-id">{{ getWorkpieceId(hbwState) ?? '-' }}</span>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Right Column: Command History -->
      <div class="hbw-tab__column hbw-tab__column--right">
        <section class="hbw-tab__section history-section">
          <h2>
            <img [src]="historyIcon" alt="History" class="section-icon-img" width="24" height="24" />
            <span>{{ labelCommandHistory }}</span>
          </h2>

          <div class="history-table-wrapper">
            <table class="history-table">
              <thead>
                <tr>
                  <th>{{ labelCommand }}</th>
                  <th>{{ labelState }}</th>
                  <th>{{ labelResult }}</th>
                  <th>{{ labelTimestamp }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let action of getRecentActions(hbwState); trackBy: trackByActionId">
                  <td>
                    <span class="command-name">{{ action.command }}</span>
                  </td>
                  <td>
                    <span class="state-badge" [class]="getStateClass(action.state)">
                      {{ getStateLabel(action.state) }}
                    </span>
                  </td>
                  <td>
                    <span class="result-badge" [class]="getResultClass(action.result)">
                      {{ getResultLabel(action.result) }}
                    </span>
                  </td>
                  <td class="timestamp">{{ formatTimestamp(action.timestamp) }}</td>
                </tr>
                <tr *ngIf="getRecentActions(hbwState).length === 0">
                  <td colspan="4" class="no-data" i18n="@@hbwNoActionsYet">No actions recorded yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <ng-template #noData>
    <div class="hbw-tab__no-data">
      <p i18n="@@hbwNoDataAvailable">No HBW data available. Waiting for MQTT messages...</p>
    </div>
  </ng-template>
</section>
