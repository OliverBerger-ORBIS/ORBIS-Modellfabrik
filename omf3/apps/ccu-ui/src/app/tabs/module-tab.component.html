<section class="module-tab">
  <header class="module-tab__toolbar">
    <div class="module-tab__title">
      <img [src]="headingIcon" alt="Shopfloor icon" class="module-tab__icon" />
      <div>
        <h1 i18n="@@moduleTabHeadline">Shopfloor</h1>
        <p class="module-tab__subtitle" i18n="@@moduleTabDescription">
          Shopfloor overview with module status, connections and actions.
        </p>
      </div>
    </div>

    <div class="module-tab__fixtures" *ngIf="isMockMode">
      <span class="badge" i18n="@@orderTabFixtureLabel">Fixture</span>
      <div class="fixture-switch">
        <button
          type="button"
          *ngFor="let fixture of fixtureOptions"
          [class.active]="fixture === activeFixture"
          (click)="loadFixture(fixture)"
        >
          {{ fixtureLabels[fixture] }}
        </button>
      </div>
    </div>
  </header>

  <span class="module-tab__hint" i18n="@@moduleTabHint">Shopfloor data updates automatically from pairing state snapshots.</span>

  <ng-container *ngIf="rows$ | async as rows; else loading">
    <div class="module-table__wrapper" *ngIf="rows.length; else empty">
      <table class="module-table">
        <thead>
          <tr>
            <th scope="col" i18n="@@moduleTableColumnId">ID</th>
            <th scope="col" i18n="@@moduleTableColumnName">Name</th>
            <th scope="col" i18n="@@moduleTableColumnRegistryActive">Registry Active</th>
            <th scope="col" i18n="@@moduleTableColumnConnected">Connected</th>
            <th scope="col" i18n="@@moduleTableColumnAvailabilityStatus">Availability Status</th>
            <th scope="col" i18n="@@moduleTableColumnMessages">Messages</th>
            <th scope="col" i18n="@@moduleTableColumnLastUpdate">Last Update</th>
            <th scope="col" i18n="@@moduleTableColumnCommand">Command</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of rows; trackBy: trackById">
            <td class="module-id">{{ row.id }}</td>
            <td class="module-name">
              <ng-container *ngIf="row.iconPath as icon">
                <img [src]="icon" [alt]="row.name" class="module-icon" />
              </ng-container>
              <span>{{ row.name }}</span>
            </td>
            <td>
              <span
                class="status-pill"
                [class.status-pill--positive]="row.registryActive"
                [class.status-pill--negative]="!row.registryActive"
              >
                <span class="status-pill__icon">{{ row.registryIcon }}</span>
                <span *ngIf="row.registryActive" i18n="@@moduleStatusActive">Active</span>
                <span *ngIf="!row.registryActive" i18n="@@moduleStatusInactive">Inactive</span>
              </span>
            </td>
            <td>
              <span class="status-indicator" [class.status-indicator--online]="row.connected">
                <span class="status-indicator__icon">{{ row.connectedIcon }}</span>
                <span *ngIf="row.connected" i18n="@@moduleStatusConnected">Connected</span>
                <span *ngIf="!row.connected" i18n="@@moduleStatusDisconnected">Disconnected</span>
              </span>
            </td>
            <td>
              <span [class]="row.availabilityClass">
                <span class="availability__icon">{{ row.availabilityIcon }}</span>
                <span>{{ row.availabilityLabel }}</span>
              </span>
            </td>
            <td>{{ row.messageCount }}</td>
            <td>{{ row.lastUpdate }}</td>
            <td>
              <div class="command-button-group">
                <button
                  type="button"
                  class="command-button"
                  *ngFor="let action of row.actions"
                  [class.command-button--secondary]="action.secondary"
                  (click)="onCommand(action)"
                >
                  {{ action.label }}
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</section>

<ng-template #loading>
  <div class="module-tab__info">
    <p i18n="@@moduleTabAwaiting">Awaiting module telemetry …</p>
  </div>
</ng-template>

<ng-template #empty>
  <div class="module-tab__info module-tab__info--empty">
    <p i18n="@@moduleTabEmpty">No module status data available.</p>
  </div>
</ng-template>

<!-- Shopfloor Preview Section (Collapsible) -->
<div class="module-tab__shopfloor-section" *ngIf="rows$ | async as rows">
  <button
    type="button"
    class="module-tab__shopfloor-toggle"
    (click)="toggleShopfloorPreview()"
    [attr.aria-expanded]="shopfloorPreviewExpanded"
    [attr.aria-label]="shopfloorPreviewExpanded ? shopfloorPreviewCollapseLabel : shopfloorPreviewExpandLabel"
  >
    <span class="toggle-icon" [class.toggle-icon--expanded]="shopfloorPreviewExpanded">▼</span>
    <span i18n="@@moduleTabShopfloorPreviewTitle">Shopfloor Layout</span>
  </button>

    <div class="module-tab__shopfloor-content" *ngIf="shopfloorPreviewExpanded">
    <p class="module-tab__shopfloor-description" i18n="@@moduleTabShopfloorPreviewDescription">
      Visual representation of module status on the shopfloor. Connected modules show a connection indicator, and color-coded availability.
    </p>
    <div class="module-tab__legend">
      <span class="legend__item">
        <span class="legend__dot legend__dot--ready"></span>
        <span i18n="@@legendAvailable">Available</span>
      </span>
      <span class="legend__item">
        <span class="legend__dot legend__dot--busy"></span>
        <span i18n="@@legendBusy">Busy</span>
      </span>
      <span class="legend__item">
        <span class="legend__dot legend__dot--blocked"></span>
        <span i18n="@@legendBlocked">Blocked</span>
      </span>
      <span class="legend__item">
        <span class="legend__dot legend__dot--unknown"></span>
        <span i18n="@@legendUnknown">Unknown</span>
      </span>
    </div>

    <div class="module-tab__shopfloor-grid">
      <div class="module-tab__shopfloor-preview-wrapper">
        <app-shopfloor-preview
          [order]="null"
          [scale]="0.6"
          [highlightModulesOverride]="selectedModuleSerialId ? [selectedModuleSerialId] : null"
          [highlightFixedOverride]="null"
          [selectionEnabled]="true"
          [showBaseRoads]="true"
          [showZoomControls]="true"
          [moduleStatusMap]="currentModuleStatusMap"
          [badgeText]="modulesStatusBadgeText"
          [infoText]="''"
          [ftsPosition]="ftsPosition"
          (cellSelected)="onModuleCellSelected($event)"
          (cellDoubleClicked)="onModuleCellDoubleClicked($event)"
        ></app-shopfloor-preview>
      </div>

      <div *ngIf="selectedModuleSerialId" class="module-tab__selection-card">
        <div class="selection-card__header">
          <div>
            <p class="selection-card__label" i18n="@@moduleTabSelectedModule">Selected module</p>
            <h3 class="selection-card__title">{{ selectedModuleName || selectedModuleSerialId }}</h3>
            <p class="selection-card__meta">{{ selectedModuleSerialId }}</p>
          </div>
          <button type="button" class="selection-card__cta" (click)="openSidebarForSelected()" i18n="@@moduleTabOpenSidebar">
            Open sidebar
          </button>
        </div>
        <div class="selection-card__body">
          <div class="selection-card__icon" *ngIf="selectedModuleIcon">
            <img [src]="selectedModuleIcon" alt="" />
          </div>
          <div class="selection-card__details">
            <div class="detail-row">
              <span class="detail-label" i18n="@@moduleTabDetailSerial">Serial</span>
              <span class="detail-value">{{ selectedModuleSerialId }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label" i18n="@@moduleTabDetailAvailability">Availability</span>
              <span class="detail-value">
                <span
                  class="availability"
                  [ngClass]="selectedModuleMeta?.availabilityClass"
                >
                  <span class="availability__icon">{{ selectedModuleMeta?.availabilityIcon }}</span>
                  <span>{{ selectedModuleMeta?.availabilityLabel }}</span>
                </span>
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label" i18n="@@moduleTabDetailConnected">Connection</span>
              <span class="detail-value">
                <span
                  class="status-indicator"
                  [class.status-indicator--online]="selectedModuleMeta?.connected === true"
                >
                  <span class="status-indicator__icon">{{ selectedModuleMeta?.connectionIcon }}</span>
                  <span>{{ selectedModuleMeta?.connectionLabel }}</span>
                </span>
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label" i18n="@@moduleTabDetailConfigured">Configured</span>
              <span class="detail-value">
                <ng-container *ngIf="selectedModuleMeta?.configured === true" i18n="@@moduleTabYes">Yes</ng-container>
                <ng-container *ngIf="selectedModuleMeta?.configured === false" i18n="@@moduleTabNo">No</ng-container>
                <ng-container *ngIf="selectedModuleMeta?.configured === undefined" i18n="@@moduleTabUnknown">Unknown</ng-container>
              </span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.ipAddress">
              <span class="detail-label" i18n="@@moduleTabDetailIp">IP</span>
              <span class="detail-value">{{ selectedModuleMeta?.ipAddress }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label" i18n="@@moduleTabDetailLastUpdate">Last update</span>
              <span class="detail-value">{{ selectedModuleMeta?.lastUpdate || 'Unknown' }}</span>
            </div>
          </div>
        </div>
        
        <!-- HBW Module-Specific Data -->
        <div class="module-specific-section" *ngIf="selectedModuleMeta?.hbwData && selectedModuleMeta?.moduleType === 'HBW'">
          <!-- Stock Grid (moved to top) -->
          <div class="module-specific-section__stock-grid">
            <app-hbw-stock-grid></app-hbw-stock-grid>
          </div>

          <div class="module-specific-section__header">
            <h4>
              <img src="assets/svg/ui/heading-storage.svg" alt="Storage" class="section-icon-img" width="20" height="20" />
              <span i18n="@@moduleTabHbwDataTitle">Storage Information</span>
            </h4>
          </div>
          <div class="module-specific-section__details">
            <div class="detail-row" *ngIf="selectedModuleMeta?.hbwData?.currentAction">
              <span class="detail-label" i18n="@@moduleTabHbwCurrentAction">Current Action</span>
              <span class="detail-value">
                <img *ngIf="getCommandEventIcon(selectedModuleMeta?.hbwData?.currentAction?.command)" [src]="getCommandEventIcon(selectedModuleMeta?.hbwData?.currentAction?.command)!" alt="" class="command-event-icon" width="20" height="20" />
                <span class="action-badge">{{ selectedModuleMeta?.hbwData?.currentAction?.command }}</span>
                <span class="state-badge">{{ selectedModuleMeta?.hbwData?.currentAction?.state }}</span>
                <span class="timestamp-badge" *ngIf="selectedModuleMeta?.hbwData?.currentAction?.timestamp">
                  {{ formatTimestamp(selectedModuleMeta?.hbwData?.currentAction?.timestamp) }}
                </span>
              </span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.hbwData?.storageSlot">
              <span class="detail-label" i18n="@@moduleTabHbwSlot">Storage Slot</span>
              <span class="detail-value">{{ selectedModuleMeta?.hbwData?.storageSlot }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.hbwData?.storageLevel">
              <span class="detail-label" i18n="@@moduleTabHbwLevel">Storage Level</span>
              <span class="detail-value">{{ selectedModuleMeta?.hbwData?.storageLevel }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.hbwData?.stockRow !== undefined && selectedModuleMeta?.hbwData?.stockRow !== null && selectedModuleMeta?.hbwData?.stockColumn !== undefined && selectedModuleMeta?.hbwData?.stockColumn !== null">
              <span class="detail-label" i18n="@@moduleTabHbwStockPosition">Stock Position</span>
              <span class="detail-value">Row: {{ selectedModuleMeta?.hbwData?.stockRow }}, Column: {{ selectedModuleMeta?.hbwData?.stockColumn }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.hbwData?.orderId">
              <span class="detail-label" i18n="@@moduleTabHbwOrderId">Order ID</span>
              <span class="detail-value">{{ selectedModuleMeta?.hbwData?.orderId }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.hbwData?.workpieceId">
              <span class="detail-label" i18n="@@moduleTabHbwWorkpieceId">Workpiece ID</span>
              <span class="detail-value mono">{{ selectedModuleMeta?.hbwData?.workpieceId }}</span>
            </div>
          </div>
          
          <!-- Command History -->
          <details class="module-specific-section__history" *ngIf="(selectedModuleMeta?.hbwData?.recentActions?.length || 0) > 0">
            <summary class="module-specific-section__history-toggle" i18n="@@moduleTabHbwCommandHistory">Command History ({{ selectedModuleMeta?.hbwData?.recentActions?.length || 0 }})</summary>
            <div class="module-specific-section__history-table-wrapper">
              <table class="module-specific-section__history-table">
                <thead>
                  <tr>
                    <th i18n="@@moduleTabHistoryCommand">Command</th>
                    <th i18n="@@moduleTabHistoryState">State</th>
                    <th *ngIf="hasAnyResult(selectedModuleMeta?.hbwData?.recentActions)" i18n="@@moduleTabHistoryResult">Result</th>
                    <th i18n="@@moduleTabHistoryTimestamp">Timestamp</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let action of selectedModuleMeta?.hbwData?.recentActions">
                    <td>
                      <span class="command-cell-content">
                        <img *ngIf="getCommandEventIcon(action.command)" [src]="getCommandEventIcon(action.command)!" alt="" class="command-event-icon" width="20" height="20" />
                        <span class="command-name">{{ action.command }}</span>
                      </span>
                    </td>
                    <td>
                      <span class="state-badge" [class]="getStateClass(action.state)">
                        {{ action.state }}
                      </span>
                    </td>
                    <td *ngIf="hasAnyResult(selectedModuleMeta?.hbwData?.recentActions)">
                      <span class="result-badge" *ngIf="action.result" [class]="getResultClass(action.result)">
                        {{ action.result }}
                      </span>
                    </td>
                    <td class="timestamp">{{ formatTimestamp(action.timestamp) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </details>
        </div>

        <!-- DRILL Module-Specific Data -->
        <div class="module-specific-section" *ngIf="selectedModuleMeta?.drillData && selectedModuleMeta?.moduleType === 'DRILL'">
          <div class="module-specific-section__header">
            <h4>
              <img src="assets/svg/ui/heading-modules.svg" alt="Drilling" class="section-icon-img" width="20" height="20" />
              <span i18n="@@moduleTabDrillDataTitle">Drilling Information</span>
            </h4>
          </div>
          <div class="module-specific-section__details">
            <div class="detail-row" *ngIf="selectedModuleMeta?.drillData?.currentAction">
              <span class="detail-label" i18n="@@moduleTabDrillCurrentAction">Current Action</span>
              <span class="detail-value">
                <img *ngIf="getCommandEventIcon(selectedModuleMeta?.drillData?.currentAction?.command)" [src]="getCommandEventIcon(selectedModuleMeta?.drillData?.currentAction?.command)!" alt="" class="command-event-icon" width="20" height="20" />
                <span class="action-badge">{{ selectedModuleMeta?.drillData?.currentAction?.command }}</span>
                <span class="state-badge">{{ selectedModuleMeta?.drillData?.currentAction?.state }}</span>
                <span class="timestamp-badge" *ngIf="selectedModuleMeta?.drillData?.currentAction?.timestamp">
                  {{ formatTimestamp(selectedModuleMeta?.drillData?.currentAction?.timestamp) }}
                </span>
              </span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.drillData?.drillDepth !== undefined && selectedModuleMeta?.drillData?.drillDepth !== null">
              <span class="detail-label" i18n="@@moduleTabDrillDepth">Drill Depth</span>
              <span class="detail-value">{{ selectedModuleMeta?.drillData?.drillDepth }} mm</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.drillData?.drillSpeed !== undefined && selectedModuleMeta?.drillData?.drillSpeed !== null">
              <span class="detail-label" i18n="@@moduleTabDrillSpeed">Drill Speed</span>
              <span class="detail-value">{{ selectedModuleMeta?.drillData?.drillSpeed }} rpm</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.drillData?.processingTime !== undefined && selectedModuleMeta?.drillData?.processingTime !== null">
              <span class="detail-label" i18n="@@moduleTabDrillProcessingTime">Processing Time</span>
              <span class="detail-value">{{ selectedModuleMeta?.drillData?.processingTime }} s</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.drillData?.orderId">
              <span class="detail-label" i18n="@@moduleTabDrillOrderId">Order ID</span>
              <span class="detail-value">{{ selectedModuleMeta?.drillData?.orderId }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.drillData?.workpieceId">
              <span class="detail-label" i18n="@@moduleTabDrillWorkpieceId">Workpiece ID</span>
              <span class="detail-value mono">{{ selectedModuleMeta?.drillData?.workpieceId }}</span>
            </div>
          </div>
          
          <!-- Command History -->
          <details class="module-specific-section__history" *ngIf="(selectedModuleMeta?.drillData?.recentActions?.length || 0) > 0">
            <summary class="module-specific-section__history-toggle" i18n="@@moduleTabDrillCommandHistory">Command History ({{ selectedModuleMeta?.drillData?.recentActions?.length || 0 }})</summary>
            <div class="module-specific-section__history-table-wrapper">
              <table class="module-specific-section__history-table">
                <thead>
                  <tr>
                    <th i18n="@@moduleTabHistoryCommand">Command</th>
                    <th i18n="@@moduleTabHistoryState">State</th>
                    <th *ngIf="hasAnyResult(selectedModuleMeta?.drillData?.recentActions)" i18n="@@moduleTabHistoryResult">Result</th>
                    <th i18n="@@moduleTabHistoryTimestamp">Timestamp</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let action of selectedModuleMeta?.drillData?.recentActions">
                    <td>
                      <span class="command-cell-content">
                        <img *ngIf="getCommandEventIcon(action.command)" [src]="getCommandEventIcon(action.command)!" alt="" class="command-event-icon" width="20" height="20" />
                        <span class="command-name">{{ action.command }}</span>
                      </span>
                    </td>
                    <td>
                      <span class="state-badge" [class]="getStateClass(action.state)">
                        {{ action.state }}
                      </span>
                    </td>
                    <td *ngIf="hasAnyResult(selectedModuleMeta?.drillData?.recentActions)">
                      <span class="result-badge" *ngIf="action.result" [class]="getResultClass(action.result)">
                        {{ action.result }}
                      </span>
                    </td>
                    <td class="timestamp">{{ formatTimestamp(action.timestamp) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </details>

          <!-- DSP Action - changeLight (DRILL specific, between History and Sequence Commands) -->
          <div class="drill-section" *ngIf="selectedModuleMeta?.moduleType === 'DRILL' && selectedModuleMeta?.drillAction">
            <div class="drill-section__header">
              <h4 i18n="@@moduleTabDrillDspAction">DSP Action – changeLight</h4>
            </div>
            <div class="drill-section__lights">
              <div class="drill-light">
                <span class="detail-label" i18n="@@moduleTabDrillCurrentLight">Current</span>
                <div
                  class="drill-light__block drill-light__block--current"
                  [style.background-color]="selectedModuleMeta?.drillAction?.currentLight || '#cccccc'"
                  [attr.aria-label]="'Current color: ' + (selectedModuleMeta?.drillAction?.currentLight || 'none')"
                >
                  <span *ngIf="!selectedModuleMeta?.drillAction?.currentLight" class="drill-light__no-value">—</span>
                </div>
                <div *ngIf="selectedModuleMeta?.drillAction?.currentLight" class="drill-light__value">
                  {{ selectedModuleMeta?.drillAction?.currentLight }}
                </div>
              </div>
              <div class="drill-light">
                <span class="detail-label" i18n="@@moduleTabDrillPreviousLight">Previous</span>
                <div
                  class="drill-light__block drill-light__block--previous"
                  [style.background-color]="selectedModuleMeta?.drillAction?.previousLight || '#cccccc'"
                  [attr.aria-label]="'Previous color: ' + (selectedModuleMeta?.drillAction?.previousLight || 'none')"
                >
                  <span *ngIf="!selectedModuleMeta?.drillAction?.previousLight" class="drill-light__no-value">—</span>
                </div>
                <div *ngIf="selectedModuleMeta?.drillAction?.previousLight" class="drill-light__value">
                  {{ selectedModuleMeta?.drillAction?.previousLight }}
                </div>
              </div>
            </div>

            <details class="drill-section__dev">
              <summary class="drill-section__dev-toggle" i18n="@@moduleTabDrillShowDeveloper">Developer (last 2 dsp/drill/action)</summary>
              <ng-container *ngIf="selectedModuleMeta?.drillAction?.messages?.length; else noDrillMessages">
                <div class="drill-msg" *ngFor="let msg of selectedModuleMeta?.drillAction?.messages">
                  <div class="drill-msg__row">
                    <span class="detail-label">Topic</span>
                    <span class="detail-value mono">{{ msg.topic }}</span>
                  </div>
                  <div class="drill-msg__row">
                    <span class="detail-label">Timestamp</span>
                    <span class="detail-value mono">{{ msg.timestamp }}</span>
                  </div>
                  <div class="drill-msg__row">
                    <span class="detail-label">Payload</span>
                    <span class="detail-value mono">{{ msg.payload | json }}</span>
                  </div>
                </div>
              </ng-container>
              <ng-template #noDrillMessages>
                <p class="detail-value" i18n="@@moduleTabDrillNoMessages">No dsp/drill/action messages yet.</p>
              </ng-template>
            </details>
          </div>
        </div>

        <!-- MILL Module-Specific Data -->
        <div class="module-specific-section" *ngIf="selectedModuleMeta?.millData && selectedModuleMeta?.moduleType === 'MILL'">
          <div class="module-specific-section__header">
            <h4>
              <img src="assets/svg/ui/heading-modules.svg" alt="Milling" class="section-icon-img" width="20" height="20" />
              <span i18n="@@moduleTabMillDataTitle">Milling Information</span>
            </h4>
          </div>
          <div class="module-specific-section__details">
            <div class="detail-row" *ngIf="selectedModuleMeta?.millData?.currentAction">
              <span class="detail-label" i18n="@@moduleTabMillCurrentAction">Current Action</span>
              <span class="detail-value">
                <img *ngIf="getCommandEventIcon(selectedModuleMeta?.millData?.currentAction?.command)" [src]="getCommandEventIcon(selectedModuleMeta?.millData?.currentAction?.command)!" alt="" class="command-event-icon" width="20" height="20" />
                <span class="action-badge">{{ selectedModuleMeta?.millData?.currentAction?.command }}</span>
                <span class="state-badge">{{ selectedModuleMeta?.millData?.currentAction?.state }}</span>
                <span class="timestamp-badge" *ngIf="selectedModuleMeta?.millData?.currentAction?.timestamp">
                  {{ formatTimestamp(selectedModuleMeta?.millData?.currentAction?.timestamp) }}
                </span>
              </span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.millData?.millDepth !== undefined && selectedModuleMeta?.millData?.millDepth !== null">
              <span class="detail-label" i18n="@@moduleTabMillDepth">Mill Depth</span>
              <span class="detail-value">{{ selectedModuleMeta?.millData?.millDepth }} mm</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.millData?.millSpeed !== undefined && selectedModuleMeta?.millData?.millSpeed !== null">
              <span class="detail-label" i18n="@@moduleTabMillSpeed">Mill Speed</span>
              <span class="detail-value">{{ selectedModuleMeta?.millData?.millSpeed }} rpm</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.millData?.processingTime !== undefined && selectedModuleMeta?.millData?.processingTime !== null">
              <span class="detail-label" i18n="@@moduleTabMillProcessingTime">Processing Time</span>
              <span class="detail-value">{{ selectedModuleMeta?.millData?.processingTime }} s</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.millData?.orderId">
              <span class="detail-label" i18n="@@moduleTabMillOrderId">Order ID</span>
              <span class="detail-value">{{ selectedModuleMeta?.millData?.orderId }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedModuleMeta?.millData?.workpieceId">
              <span class="detail-label" i18n="@@moduleTabMillWorkpieceId">Workpiece ID</span>
              <span class="detail-value mono">{{ selectedModuleMeta?.millData?.workpieceId }}</span>
            </div>
          </div>
          
          <!-- Command History -->
          <details class="module-specific-section__history" *ngIf="(selectedModuleMeta?.millData?.recentActions?.length || 0) > 0">
            <summary class="module-specific-section__history-toggle" i18n="@@moduleTabMillCommandHistory">Command History ({{ selectedModuleMeta?.millData?.recentActions?.length || 0 }})</summary>
            <div class="module-specific-section__history-table-wrapper">
              <table class="module-specific-section__history-table">
                <thead>
                  <tr>
                    <th i18n="@@moduleTabHistoryCommand">Command</th>
                    <th i18n="@@moduleTabHistoryState">State</th>
                    <th *ngIf="hasAnyResult(selectedModuleMeta?.millData?.recentActions)" i18n="@@moduleTabHistoryResult">Result</th>
                    <th i18n="@@moduleTabHistoryTimestamp">Timestamp</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let action of selectedModuleMeta?.millData?.recentActions">
                    <td>
                      <span class="command-cell-content">
                        <img *ngIf="getCommandEventIcon(action.command)" [src]="getCommandEventIcon(action.command)!" alt="" class="command-event-icon" width="20" height="20" />
                        <span class="command-name">{{ action.command }}</span>
                      </span>
                    </td>
                    <td>
                      <span class="state-badge" [class]="getStateClass(action.state)">
                        {{ action.state }}
                      </span>
                    </td>
                    <td *ngIf="hasAnyResult(selectedModuleMeta?.millData?.recentActions)">
                      <span class="result-badge" *ngIf="action.result" [class]="getResultClass(action.result)">
                        {{ action.result }}
                      </span>
                    </td>
                    <td class="timestamp">{{ formatTimestamp(action.timestamp) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </details>
        </div>

        <!-- DPS Section -->
        <div class="module-specific-section" *ngIf="selectedModuleMeta?.moduleType === 'DPS' && selectedModuleMeta?.dpsData as dpsState">
          <div class="module-specific-section__header">
            <h4>
              <img src="assets/svg/ui/heading-modules.svg" alt="Delivery and Pickup" class="section-icon-img" width="20" height="20" />
              <span i18n="@@moduleTabDpsInformation">Delivery and Pickup Information</span>
            </h4>
          </div>

          <div class="module-specific-section__details">
            <!-- Only show additional info not already displayed above -->
                <div class="detail-row" *ngIf="dpsState?.actionState as action">
                  <span class="detail-label" i18n="@@dpsLabelCurrentAction">Current Action</span>
                  <span class="detail-value">
                    <img *ngIf="getCommandEventIcon(action.command)" [src]="getCommandEventIcon(action.command)!" alt="" class="command-event-icon" width="20" height="20" />
                    <span class="action-badge" [class]="getDpsStateClass(action.state)">
                      <span class="command">{{ action.command }}</span>
                  <span class="state">{{ getDpsStateLabel(action.state) }}</span>
                </span>
              </span>
            </div>

            <div class="detail-row">
              <span class="detail-label" i18n="@@dpsLabelOrderId">Order ID</span>
              <span class="detail-value">{{ getDpsOrderIdDisplay(dpsState?.orderId) }}</span>
            </div>

            <!-- Workpiece Information integrated here -->
            <div class="detail-row" *ngIf="getDpsWorkpieceColor(dpsState) as color">
              <span class="detail-label" i18n="@@dpsLabelColor">Workpiece Color</span>
              <span class="detail-value">
                <div class="workpiece-color-display">
                  <img *ngIf="getDpsWorkpieceIcon(color)" [src]="getDpsWorkpieceIcon(color)" [alt]="getDpsColorLabel(color)" class="workpiece-3d-icon" width="48" height="48" />
                  <span class="color-text">{{ getDpsColorLabel(color) }}</span>
                </div>
              </span>
            </div>

            <div class="detail-row" *ngIf="getDpsNfcCode(dpsState) as nfcCode">
              <span class="detail-label" i18n="@@dpsLabelNfcCode">NFC Code (WorkpieceId)</span>
              <span class="detail-value mono">{{ nfcCode }}</span>
            </div>

            <div class="detail-row" *ngIf="getDpsWorkpieceState(dpsState) as workpieceState">
              <span class="detail-label" i18n="@@dpsLabelWorkpieceState">Workpiece State</span>
              <span class="detail-value">{{ workpieceState }}</span>
            </div>
          </div>

          <!-- Command History -->
          <details class="module-specific-section__history" *ngIf="dpsState?.actionState || getDpsRecentActions(dpsState).length > 0">
            <summary class="module-specific-section__history-toggle" i18n="@@dpsLabelHistory">Command History ({{ getDpsRecentActions(dpsState).length || (dpsState?.actionState ? 1 : 0) }})</summary>
            <div class="module-specific-section__history-table-wrapper">
              <table class="module-specific-section__history-table">
                <thead>
                  <tr>
                    <th i18n="@@dpsLabelCommand">Command</th>
                    <th i18n="@@dpsLabelState">State</th>
                    <th *ngIf="hasDpsAnyResult(dpsState)" i18n="@@dpsLabelResult">Result</th>
                    <th i18n="@@dpsLabelTimestamp">Timestamp</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngIf="getDpsRecentActions(dpsState).length === 0 && dpsState?.actionState as action">
                    <tr>
                      <td>
                        <img *ngIf="getCommandEventIcon(action.command)" [src]="getCommandEventIcon(action.command)!" alt="" class="command-event-icon" width="20" height="20" />
                        <span class="command-name">{{ action.command }}</span>
                      </td>
                      <td>
                        <span class="state-badge" [class]="getDpsStateClass(action.state)">
                          {{ getDpsStateLabel(action.state) }}
                        </span>
                      </td>
                      <td *ngIf="hasDpsAnyResult(dpsState)">
                        <span class="result-badge" *ngIf="action.result" [class]="getDpsResultClass(action.result)">
                          {{ getDpsResultLabel(action.result) }}
                        </span>
                      </td>
                      <td class="timestamp">{{ formatDpsTimestamp(action.timestamp) }}</td>
                    </tr>
                  </ng-container>
                  <tr *ngFor="let action of getDpsRecentActions(dpsState); trackBy: trackByDpsActionId">
                    <td>
                      <span class="command-cell-content">
                        <img *ngIf="getCommandEventIcon(action.command)" [src]="getCommandEventIcon(action.command)!" alt="" class="command-event-icon" width="20" height="20" />
                        <span class="command-name">{{ action.command }}</span>
                      </span>
                    </td>
                    <td>
                      <span class="state-badge" [class]="getDpsStateClass(action.state)">
                        {{ getDpsStateLabel(action.state) }}
                      </span>
                    </td>
                      <td *ngIf="hasDpsAnyResult(dpsState)">
                      <span class="result-badge" *ngIf="action.result" [class]="getDpsResultClass(action.result)">
                        {{ getDpsResultLabel(action.result) }}
                      </span>
                    </td>
                    <td class="timestamp">{{ formatDpsTimestamp(action.timestamp) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </details>
        </div>

        <!-- AIQS Section -->
        <div class="module-specific-section" *ngIf="selectedModuleMeta?.moduleType === 'AIQS' && selectedModuleMeta?.aiqsData as aiqsState">
          <div class="module-specific-section__header">
            <h4>
              <img src="assets/svg/ui/heading-sensors.svg" alt="Check Quality" class="section-icon-img" width="20" height="20" />
              <span i18n="@@moduleTabAiqsInformation">Check Quality Information</span>
            </h4>
          </div>

          <div class="module-specific-section__details">
            <!-- Only show additional info not already displayed above -->
            <div class="detail-row" *ngIf="aiqsState?.actionState as action">
              <span class="detail-label" i18n="@@aiqsLabelCurrentAction">Current Action</span>
              <span class="detail-value">
                <img *ngIf="getCommandEventIcon(action.command)" [src]="getCommandEventIcon(action.command)!" alt="" class="command-event-icon" width="20" height="20" />
                <span class="action-badge" [class]="getAiqsStateClass(action.state)">
                  <span class="command">{{ action.command }}</span>
                  <span class="state">{{ getAiqsStateLabel(action.state) }}</span>
                  <span class="result-badge" *ngIf="action.command === 'CHECK_QUALITY' && action.result" [class]="getAiqsResultClass(action.result)">
                    {{ action.result === 'PASSED' ? 'TRUE' : (action.result === 'FAILED' ? 'FALSE' : action.result) }}
                  </span>
                </span>
              </span>
            </div>

            <div class="detail-row">
              <span class="detail-label" i18n="@@aiqsLabelOrderId">Order ID</span>
              <span class="detail-value">{{ getAiqsOrderIdDisplay(aiqsState?.orderId) }}</span>
            </div>
            <div class="detail-row" *ngIf="getAiqsWorkpieceId(aiqsState)">
              <span class="detail-label" i18n="@@aiqsLabelWorkpieceId">Workpiece ID</span>
              <span class="detail-value mono">{{ getAiqsWorkpieceId(aiqsState) }}</span>
            </div>
          </div>

          <!-- Quality Results -->
          <div class="module-specific-section__quality" *ngIf="getAiqsTotalChecks(aiqsState) > 0">
            <div class="module-specific-section__header">
              <h4>
                <img src="assets/svg/ui/heading-sensors.svg" alt="Quality" class="section-icon-img" width="20" height="20" />
                <span i18n="@@aiqsLabelResults">Quality Results</span>
              </h4>
            </div>

            <div class="module-specific-section__details">
              <div class="detail-row">
                <span class="detail-label" i18n="@@aiqsLabelTotal">Total Checks</span>
                <span class="detail-value total-count">{{ getAiqsTotalChecks(aiqsState) }}</span>
              </div>

              <div class="detail-row">
                <span class="detail-label" i18n="@@aiqsLabelPassed">Passed</span>
                <span class="detail-value">
                  <img src="assets/svg/shopfloor/shared/status-online.svg" alt="Passed" width="16" height="16" />
                  <span>{{ getAiqsPassedCount(aiqsState) }}</span>
                </span>
              </div>

              <div class="detail-row">
                <span class="detail-label" i18n="@@aiqsLabelFailed">Failed</span>
                <span class="detail-value">
                  <img src="assets/svg/shopfloor/shared/status-offline.svg" alt="Failed" width="16" height="16" />
                  <span>{{ getAiqsFailedCount(aiqsState) }}</span>
                </span>
              </div>

              <div class="detail-row">
                <span class="detail-label" i18n="@@aiqsLabelSuccessRate">Success Rate</span>
                <span class="detail-value">{{ getAiqsSuccessRate(aiqsState) }}%</span>
              </div>
            </div>
          </div>

          <!-- Check History -->
          <details class="module-specific-section__history" *ngIf="aiqsState?.actionState || getAiqsRecentActions(aiqsState).length > 0">
            <summary class="module-specific-section__history-toggle" i18n="@@aiqsLabelHistory">Check History ({{ getAiqsRecentActions(aiqsState).length || (aiqsState?.actionState ? 1 : 0) }})</summary>
            <div class="module-specific-section__history-table-wrapper">
              <table class="module-specific-section__history-table">
                <thead>
                  <tr>
                    <th i18n="@@aiqsLabelCommand">Command</th>
                    <th i18n="@@aiqsLabelState">State</th>
                    <th *ngIf="hasAiqsAnyResult(aiqsState)" i18n="@@aiqsLabelResult">Result</th>
                    <th i18n="@@aiqsLabelTimestamp">Timestamp</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngIf="getAiqsRecentActions(aiqsState).length === 0 && aiqsState?.actionState as action">
                    <tr>
                      <td>
                        <span class="command-cell-content">
                          <img *ngIf="getCommandEventIcon(action.command)" [src]="getCommandEventIcon(action.command)!" alt="" class="command-event-icon" width="20" height="20" />
                          <span class="command-name">{{ action.command }}</span>
                        </span>
                      </td>
                      <td>
                        <span class="state-badge" [class]="getAiqsStateClass(action.state)">
                          {{ getAiqsStateLabel(action.state) }}
                        </span>
                      </td>
                      <td *ngIf="hasAiqsAnyResult(aiqsState)">
                        <span class="result-badge" *ngIf="action.result" [class]="getAiqsResultClass(action.result)">
                          {{ getAiqsResultLabel(action.result) }}
                        </span>
                      </td>
                      <td class="timestamp">{{ formatAiqsTimestamp(action.timestamp) }}</td>
                    </tr>
                  </ng-container>
                  <tr *ngFor="let action of getAiqsRecentActions(aiqsState); trackBy: trackByAiqsActionId">
                    <td>
                      <span class="command-cell-content">
                        <img *ngIf="getCommandEventIcon(action.command)" [src]="getCommandEventIcon(action.command)!" alt="" class="command-event-icon" width="20" height="20" />
                        <span class="command-name">{{ action.command }}</span>
                      </span>
                    </td>
                    <td>
                      <span class="state-badge" [class]="getAiqsStateClass(action.state)">
                        {{ getAiqsStateLabel(action.state) }}
                      </span>
                    </td>
                    <td *ngIf="hasAiqsAnyResult(aiqsState)">
                      <span class="result-badge" *ngIf="action.result" [class]="getAiqsResultClass(action.result)">
                        {{ getAiqsResultLabel(action.result) }}
                      </span>
                    </td>
                    <td class="timestamp">{{ formatAiqsTimestamp(action.timestamp) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </details>
        </div>
        
        <!-- Sequence Commands (collapsed, at the bottom for DRILL/MILL/AIQS) -->
        <details class="sequence-commands-section" *ngIf="sequenceCommands && (selectedModuleMeta?.moduleType === 'DRILL' || selectedModuleMeta?.moduleType === 'MILL' || selectedModuleMeta?.moduleType === 'AIQS')">
          <summary class="sequence-commands__header">
            <h4 i18n="@@moduleTabSequenceCommandsTitle">Sequence Commands</h4>
            <span class="sequence-commands__chevron"></span>
          </summary>
          <div class="sequence-commands__content">
            <div class="sequence-commands__description">
              <p class="sequence-commands__warning" i18n="@@moduleTabSequenceCommandsWarning">
                Do not execute during running production process.
              </p>
              <p i18n="@@moduleTabSequenceCommandsDescription">
                Send commands manually in sequence. Wait for each command to complete before sending the next.
              </p>
            </div>
            <div class="sequence-commands__list">
              <div 
                class="sequence-command-item"
                *ngFor="let cmd of sequenceCommands.commands; let i = index"
                [class.sequence-command-item--sent]="isCommandSent(i)"
              >
                <span class="sequence-command__number">{{ i + 1 }}</span>
                <span class="sequence-command__label">{{ cmd.action.command }}</span>
                <span class="sequence-command__status" *ngIf="isCommandSent(i)" i18n="@@moduleTabSequenceCommandSent">Sent</span>
              </div>
            </div>
            <div class="sequence-commands__actions">
              <button
                type="button"
                class="command-button"
                *ngFor="let cmd of sequenceCommands.commands; let i = index"
                [disabled]="isCommandSent(i)"
                (click)="sendSequenceCommand(i)"
              >
                <span i18n="@@moduleTabSequenceCommandSend">Senden</span> {{ cmd.action.command }}
              </button>
              <button
                type="button"
                class="command-button command-button--secondary"
                [disabled]="sentSequenceCommands.length === 0"
                (click)="resetSequenceCommands()"
                i18n="@@moduleTabSequenceCommandReset"
              >
                Zurücksetzen
              </button>
            </div>
            <details class="sequence-commands__dev">
              <summary class="sequence-commands__dev-toggle" i18n="@@moduleTabSequenceCommandsShowDeveloper">Developer (last sent sequence commands)</summary>
              <ng-container *ngIf="sentSequenceCommands.length > 0; else noSequenceMessages">
                <div class="sequence-msg" *ngFor="let sent of sentSequenceCommands">
                  <div class="sequence-msg__row">
                    <span class="detail-label">Topic</span>
                    <span class="detail-value mono">{{ sent.topic }}</span>
                  </div>
                  <div class="sequence-msg__row">
                    <span class="detail-label">Timestamp</span>
                    <span class="detail-value mono">{{ sent.timestamp }}</span>
                  </div>
                  <div class="sequence-msg__row">
                    <span class="detail-label">Command</span>
                    <span class="detail-value mono">{{ sent.command.action.command }}</span>
                  </div>
                  <div class="sequence-msg__row">
                    <span class="detail-label">Payload</span>
                    <pre class="detail-value mono"><code>{{ formatJsonPayload(sent.command) }}</code></pre>
                  </div>
                </div>
              </ng-container>
              <ng-template #noSequenceMessages>
                <p class="detail-value" i18n="@@moduleTabSequenceCommandsNoMessages">No sequence commands sent yet.</p>
              </ng-template>
            </details>
          </div>
        </details>
      </div>
    </div>
  </div>
</div>

<!-- Module Details Sidebar -->
<app-module-details-sidebar
  [isOpen]="sidebarOpen"
  [serialId]="selectedModuleSerialId"
  [moduleName]="selectedModuleName"
  (close)="closeSidebar()"
></app-module-details-sidebar>

