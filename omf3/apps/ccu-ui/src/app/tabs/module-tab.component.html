<section class="module-tab">
  <header class="module-tab__toolbar">
    <div class="module-tab__title">
      <img [src]="headingIcon" alt="Modules icon" class="module-tab__icon" />
      <div>
        <h1 i18n="@@moduleTabHeadline">Modules</h1>
        <p class="module-tab__subtitle" i18n="@@moduleTabDescription">
          Module overview with status, connections and actions.
        </p>
      </div>
    </div>

    <div class="module-tab__fixtures" *ngIf="isMockMode">
      <span class="badge" i18n="@@orderTabFixtureLabel">Fixture</span>
      <div class="fixture-switch">
        <button
          type="button"
          *ngFor="let fixture of fixtureOptions"
          [class.active]="fixture === activeFixture"
          (click)="loadFixture(fixture)"
        >
          {{ fixtureLabels[fixture] }}
        </button>
      </div>
    </div>
  </header>

  <span class="module-tab__hint" i18n="@@moduleTabHint">Data updates automatically from pairing state snapshots.</span>

  <ng-container *ngIf="rows$ | async as rows; else loading">
    <div class="module-table__wrapper" *ngIf="rows.length; else empty">
      <table class="module-table">
        <thead>
          <tr>
            <th scope="col" i18n="@@moduleTableColumnId">ID</th>
            <th scope="col" i18n="@@moduleTableColumnName">Name</th>
            <th scope="col" i18n="@@moduleTableColumnRegistryActive">Registry Active</th>
            <th scope="col" i18n="@@moduleTableColumnConnected">Connected</th>
            <th scope="col" i18n="@@moduleTableColumnAvailabilityStatus">Availability Status</th>
            <th scope="col" i18n="@@moduleTableColumnMessages">Messages</th>
            <th scope="col" i18n="@@moduleTableColumnLastUpdate">Last Update</th>
            <th scope="col" i18n="@@moduleTableColumnCommand">Command</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of rows; trackBy: trackById">
            <td class="module-id">{{ row.id }}</td>
            <td class="module-name">
              <ng-container *ngIf="row.iconPath as icon">
                <img [src]="icon" [alt]="row.name" class="module-icon" />
              </ng-container>
              <span>{{ row.name }}</span>
            </td>
            <td>
              <span
                class="status-pill"
                [class.status-pill--positive]="row.registryActive"
                [class.status-pill--negative]="!row.registryActive"
              >
                <span class="status-pill__icon">{{ row.registryIcon }}</span>
                <span *ngIf="row.registryActive" i18n="@@moduleStatusActive">Active</span>
                <span *ngIf="!row.registryActive" i18n="@@moduleStatusInactive">Inactive</span>
              </span>
            </td>
            <td>
              <span class="status-indicator" [class.status-indicator--online]="row.connected">
                <span class="status-indicator__icon">{{ row.connectedIcon }}</span>
                <span *ngIf="row.connected" i18n="@@moduleStatusConnected">Connected</span>
                <span *ngIf="!row.connected" i18n="@@moduleStatusDisconnected">Disconnected</span>
              </span>
            </td>
            <td>
              <span [class]="row.availabilityClass">
                <span class="availability__icon">{{ row.availabilityIcon }}</span>
                <span>{{ row.availabilityLabel }}</span>
              </span>
            </td>
            <td>{{ row.messageCount }}</td>
            <td>{{ row.lastUpdate }}</td>
            <td>
              <div class="command-button-group">
                <button
                  type="button"
                  class="command-button"
                  *ngFor="let action of row.actions"
                  [class.command-button--secondary]="action.secondary"
                  (click)="onCommand(action)"
                >
                  {{ action.label }}
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</section>

<ng-template #loading>
  <div class="module-tab__info">
    <p i18n="@@moduleTabAwaiting">Awaiting module telemetry …</p>
  </div>
</ng-template>

<ng-template #empty>
  <div class="module-tab__info module-tab__info--empty">
    <p i18n="@@moduleTabEmpty">No module status data available.</p>
  </div>
</ng-template>

<!-- Shopfloor Preview Section (Collapsible) -->
<div class="module-tab__shopfloor-section" *ngIf="rows$ | async as rows">
  <button
    type="button"
    class="module-tab__shopfloor-toggle"
    (click)="toggleShopfloorPreview()"
    [attr.aria-expanded]="shopfloorPreviewExpanded"
    [attr.aria-label]="shopfloorPreviewExpanded ? shopfloorPreviewCollapseLabel : shopfloorPreviewExpandLabel"
  >
    <span class="toggle-icon" [class.toggle-icon--expanded]="shopfloorPreviewExpanded">▼</span>
    <span i18n="@@moduleTabShopfloorPreviewTitle">Shopfloor Layout</span>
  </button>

  <div class="module-tab__shopfloor-content" *ngIf="shopfloorPreviewExpanded">
    <p class="module-tab__shopfloor-description" i18n="@@moduleTabShopfloorPreviewDescription">
      Visual representation of module status on the shopfloor. Connected modules show a connection indicator, and availability is indicated by colored borders (green: Available, orange: Busy, red: Blocked).
    </p>
    <div class="module-tab__shopfloor-preview-wrapper">
      <app-shopfloor-preview
        [order]="null"
        [scale]="0.6"
        [highlightModulesOverride]="null"
        [highlightFixedOverride]="null"
        [selectionEnabled]="true"
        [showBaseRoads]="true"
        [showZoomControls]="true"
        [moduleStatusMap]="currentModuleStatusMap"
        [badgeText]="'Modules Status'"
        [infoText]="''"
        [ftsPosition]="ftsPosition"
        (cellSelected)="onModuleCellSelected($event)"
      ></app-shopfloor-preview>
    </div>
  </div>
</div>

<!-- Module Details Sidebar -->
<app-module-details-sidebar
  [isOpen]="sidebarOpen"
  [serialId]="selectedModuleSerialId"
  [moduleName]="selectedModuleName"
  (close)="closeSidebar()"
></app-module-details-sidebar>

