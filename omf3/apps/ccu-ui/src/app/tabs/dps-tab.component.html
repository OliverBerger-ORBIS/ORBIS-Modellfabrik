<section class="dps-tab">
  <header class="dps-tab__toolbar">
    <div class="dps-tab__title">
      <img [src]="headingIcon" alt="DPS" class="dps-tab__icon" width="32" height="32" />
      <div>
        <h1>{{ headingTitle }}</h1>
        <p class="dps-tab__subtitle">
          {{ headingSubtitle }}
        </p>
      </div>
    </div>
  </header>

  <div class="dps-tab__content" *ngIf="dpsState$ | async as dpsState; else noData">
    <div class="dps-tab__grid">
      <!-- Left Column: Status & Connection -->
      <div class="dps-tab__column dps-tab__column--left">
        <!-- Status Section -->
        <section class="dps-tab__section status-section">
          <h2>
            <img [src]="statusIcon" alt="Status" class="section-icon-img" width="24" height="24" />
            <span i18n="@@dpsStatusHeading">Status</span>
            <span class="serial-badge">{{ dpsState.serialNumber }}</span>
          </h2>
          
          <div class="status-card">
            <div class="status-item">
              <span class="status-label">{{ labelConnection }}</span>
              <div class="status-value">
                <span class="status-badge" [class.online]="getConnectionStatus(dpsState) === 'ONLINE'" [class.offline]="getConnectionStatus(dpsState) === 'OFFLINE'">
                  <img [src]="getConnectionStatus(dpsState) === 'ONLINE' ? connectionOnlineIcon : connectionOfflineIcon" alt="" width="16" height="16" />
                  <span>{{ getConnectionStatus(dpsState) === 'ONLINE' ? statusOnline : statusOffline }}</span>
                </span>
              </div>
            </div>

            <div class="status-item">
              <span class="status-label">{{ labelAvailability }}</span>
              <div class="status-value">
                <span class="status-badge" 
                      [class.ready]="getAvailability(dpsState) === 'READY'" 
                      [class.busy]="getAvailability(dpsState) === 'BUSY'"
                      [class.error]="getAvailability(dpsState) === 'ERROR'">
                  <span>{{ getAvailability(dpsState) === 'READY' ? statusReady : (getAvailability(dpsState) === 'BUSY' ? statusBusy : statusError) }}</span>
                </span>
              </div>
            </div>

            <div class="status-item">
              <span class="status-label">{{ labelOrderId }}</span>
              <div class="status-value">
                <span class="order-id">{{ getOrderIdDisplay(dpsState.orderId) }}</span>
              </div>
            </div>

            <div class="status-item" *ngIf="getCurrentAction(dpsState) as action">
              <span class="status-label">{{ labelCurrentAction }}</span>
              <div class="status-value">
                <span class="action-badge" [class]="getStateClass(action.state)">
                  <span class="command">{{ action.command }}</span>
                  <span class="state">{{ getStateLabel(action.state) }}</span>
                </span>
              </div>
            </div>
          </div>
        </section>

        <!-- Workpiece Information Section -->
        <section class="dps-tab__section workpiece-section">
          <h2>
            <img [src]="workpieceIcon" alt="Workpiece" class="section-icon-img" width="24" height="24" />
            <span i18n="@@dpsWorkpieceHeading">Workpiece Information</span>
          </h2>

          <div class="workpiece-card">
            <div class="workpiece-item">
              <span class="workpiece-label">{{ labelWorkpieceColor }}</span>
              <div class="workpiece-value">
                <span class="color-indicator" [class]="'color-' + getColorClass(getWorkpieceColor(dpsState))"></span>
                <span class="color-text">{{ getColorLabel(getWorkpieceColor(dpsState)) }}</span>
              </div>
            </div>

            <div class="workpiece-item">
              <span class="workpiece-label">{{ labelNfcCode }}</span>
              <div class="workpiece-value">
                <span class="nfc-code">{{ getNfcCode(dpsState) ?? labelNfcNone }}</span>
              </div>
            </div>

            <div class="workpiece-item" *ngIf="getWorkpieceState(dpsState) as workpieceState">
              <span class="workpiece-label">{{ labelWorkpieceState }}</span>
              <div class="workpiece-value">
                <span class="workpiece-state">{{ workpieceState }}</span>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Right Column: Command History -->
      <div class="dps-tab__column dps-tab__column--right">
        <section class="dps-tab__section history-section">
          <h2>
            <img [src]="historyIcon" alt="History" class="section-icon-img" width="24" height="24" />
            <span>{{ labelCommandHistory }}</span>
          </h2>

          <div class="history-table-wrapper">
            <table class="history-table">
              <thead>
                <tr>
                  <th>{{ labelCommand }}</th>
                  <th>{{ labelState }}</th>
                  <th>{{ labelResult }}</th>
                  <th>{{ labelTimestamp }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let action of getRecentActions(dpsState); trackBy: trackByActionId">
                  <td>
                    <span class="command-name">{{ action.command }}</span>
                  </td>
                  <td>
                    <span class="state-badge" [class]="getStateClass(action.state)">
                      {{ getStateLabel(action.state) }}
                    </span>
                  </td>
                  <td>
                    <span class="result-badge" [class]="getResultClass(action.result)">
                      {{ getResultLabel(action.result) }}
                    </span>
                  </td>
                  <td class="timestamp">{{ formatTimestamp(action.timestamp) }}</td>
                </tr>
                <tr *ngIf="getRecentActions(dpsState).length === 0">
                  <td colspan="4" class="no-data" i18n="@@dpsNoActionsYet">No actions recorded yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <ng-template #noData>
    <div class="dps-tab__no-data">
      <p i18n="@@dpsNoDataAvailable">No DPS data available. Waiting for MQTT messages...</p>
    </div>
  </ng-template>
</section>
