<section class="drill-tab">
  <header class="drill-tab__toolbar">
    <div class="drill-tab__title">
      <img [src]="headingIcon" alt="DRILL" class="drill-tab__icon" width="32" height="32" />
      <div>
        <h1>{{ headingTitle }}</h1>
        <p class="drill-tab__subtitle">
          {{ headingSubtitle }}
        </p>
      </div>
    </div>
    <div class="drill-tab__fixtures" *ngIf="isMockMode">
      <span class="badge" i18n="@@orderTabFixtureLabel">Fixture</span>
      <div class="fixture-switch">
        <button
          type="button"
          *ngFor="let fixture of fixtureOptions"
          [class.active]="fixture === activeFixture"
          (click)="loadFixture(fixture)"
        >
          {{ fixtureLabels[fixture] }}
        </button>
      </div>
      <div class="environment-hint" *ngIf="isReplayMode">
        <span i18n="@@drillReplayHint">Using replay environment - DRILL data from MQTT broker</span>
      </div>
    </div>
  </header>

  <div class="drill-tab__content" *ngIf="drillState$ | async as drillState; else noData">
    <div class="drill-tab__grid">
      <!-- Left Column: Status & Connection -->
      <div class="drill-tab__column drill-tab__column--left">
        <!-- Status Section -->
        <section class="drill-tab__section status-section">
          <h2>
            <img [src]="statusIcon" alt="Status" class="section-icon-img" width="24" height="24" />
            <span i18n="@@drillStatusHeading">Status</span>
            <span class="serial-badge">{{ drillState.serialNumber }}</span>
          </h2>
          
          <div class="status-card">
            <div class="status-item">
              <span class="status-label">{{ labelConnection }}</span>
              <div class="status-value">
                <span class="status-badge" [class.online]="getConnectionStatus(drillState) === 'ONLINE'" [class.offline]="getConnectionStatus(drillState) === 'OFFLINE'">
                  <img [src]="getConnectionStatus(drillState) === 'ONLINE' ? connectionOnlineIcon : connectionOfflineIcon" alt="" width="16" height="16" />
                  <span>{{ getConnectionStatus(drillState) === 'ONLINE' ? statusOnline : statusOffline }}</span>
                </span>
              </div>
            </div>

            <div class="status-item">
              <span class="status-label">{{ labelAvailability }}</span>
              <div class="status-value">
                <span class="status-badge" 
                      [class.ready]="getAvailability(drillState) === 'READY'" 
                      [class.busy]="getAvailability(drillState) === 'BUSY'"
                      [class.error]="getAvailability(drillState) === 'ERROR'">
                  <span>{{ getAvailability(drillState) === 'READY' ? statusReady : (getAvailability(drillState) === 'BUSY' ? statusBusy : statusError) }}</span>
                </span>
              </div>
            </div>

            <div class="status-item">
              <span class="status-label">{{ labelOrderId }}</span>
              <div class="status-value">
                <span class="order-id">{{ getOrderIdDisplay(drillState.orderId) }}</span>
              </div>
            </div>

            <div class="status-item" *ngIf="getCurrentAction(drillState) as action">
              <span class="status-label">{{ labelCurrentAction }}</span>
              <div class="status-value">
                <span class="action-badge" [class]="getStateClass(action.state)">
                  <span class="command">{{ action.command }}</span>
                  <span class="state">{{ getStateLabel(action.state) }}</span>
                </span>
              </div>
            </div>
          </div>
        </section>

        <!-- Drilling Information Section -->
        <section class="drill-tab__section drilling-section">
          <h2>
            <img [src]="drillIcon" alt="Drilling" class="section-icon-img" width="24" height="24" />
            <span>{{ labelDrillingInfo }}</span>
          </h2>

          <div class="drilling-card">
            <div class="drilling-item" *ngIf="getDrillDepth(drillState) as depth">
              <span class="drilling-label">{{ labelDrillDepth }}</span>
              <div class="drilling-value">
                <span class="depth-value">{{ depth }} mm</span>
              </div>
            </div>

            <div class="drilling-item" *ngIf="getDrillSpeed(drillState) as speed">
              <span class="drilling-label">{{ labelDrillSpeed }}</span>
              <div class="drilling-value">
                <span class="speed-value">{{ speed }} rpm</span>
              </div>
            </div>

            <div class="drilling-item">
              <span class="drilling-label">{{ labelWorkpieceId }}</span>
              <div class="drilling-value">
                <span class="workpiece-id">{{ getWorkpieceId(drillState) ?? '-' }}</span>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Right Column: Command History -->
      <div class="drill-tab__column drill-tab__column--right">
        <section class="drill-tab__section history-section">
          <h2>
            <img [src]="historyIcon" alt="History" class="section-icon-img" width="24" height="24" />
            <span>{{ labelCommandHistory }}</span>
          </h2>

          <div class="history-table-wrapper">
            <table class="history-table">
              <thead>
                <tr>
                  <th>{{ labelCommand }}</th>
                  <th>{{ labelState }}</th>
                  <th>{{ labelResult }}</th>
                  <th>{{ labelTimestamp }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let action of getRecentActions(drillState); trackBy: trackByActionId">
                  <td>
                    <span class="command-name">{{ action.command }}</span>
                  </td>
                  <td>
                    <span class="state-badge" [class]="getStateClass(action.state)">
                      {{ getStateLabel(action.state) }}
                    </span>
                  </td>
                  <td>
                    <span class="result-badge" [class]="getResultClass(action.result)">
                      {{ getResultLabel(action.result) }}
                    </span>
                  </td>
                  <td class="timestamp">{{ formatTimestamp(action.timestamp) }}</td>
                </tr>
                <tr *ngIf="getRecentActions(drillState).length === 0">
                  <td colspan="4" class="no-data" i18n="@@drillNoActionsYet">No actions recorded yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <ng-template #noData>
    <div class="drill-tab__no-data">
      <p i18n="@@drillNoDataAvailable">No DRILL data available. Waiting for MQTT messages...</p>
    </div>
  </ng-template>
</section>
