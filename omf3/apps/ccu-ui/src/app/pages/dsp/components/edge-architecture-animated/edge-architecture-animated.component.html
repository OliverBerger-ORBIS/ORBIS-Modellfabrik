<div class="edge-architecture-animated">
  <div class="edge-architecture-animated__header">
    <div class="header__title">
      <h2>{{ sectionTitle }}</h2>
      <p class="subtitle">{{ sectionSubtitle }}</p>
    </div>
    
    <!-- Step Navigation -->
    <div class="header__controls">
      <div class="step-navigation">
        <button
          *ngFor="let step of steps; let i = index"
          class="step-button"
          [class.step-button--active]="i === currentStepIndex"
          (click)="goToStep(i)"
          [attr.aria-label]="'Step ' + (i + 1)"
        >
          {{ i + 1 }}
        </button>
      </div>
      
      <div class="playback-controls">
        <button
          class="control-btn"
          [disabled]="isFirstStep"
          (click)="prevStep()"
          [attr.aria-label]="btnPrev"
        >
          ‹
        </button>
        <button
          class="control-btn control-btn--autoplay"
          (click)="toggleAutoPlay()"
          [class.control-btn--active]="isAutoPlaying"
        >
          {{ isAutoPlaying ? btnStopPlay : btnAutoPlay }}
        </button>
        <button
          class="control-btn"
          [disabled]="isLastStep"
          (click)="nextStep()"
          [attr.aria-label]="btnNext"
        >
          ›
        </button>
      </div>
    </div>
  </div>
  
  <!-- Step Description -->
  <div class="edge-architecture-animated__step-info" *ngIf="currentStep">
    <div class="step-info__label">{{ currentStep.label }}</div>
    <div class="step-info__description">{{ currentStep.description }}</div>
  </div>
  
  <!-- SVG Diagram -->
  <div class="edge-architecture-animated__diagram-wrapper">
    <svg
      class="edge-architecture-animated__diagram"
      [attr.viewBox]="viewBox"
      preserveAspectRatio="xMidYMid meet"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
    >
      <!-- Define arrow markers -->
      <defs>
        <marker
          id="arrowhead-edge-anim"
          markerWidth="10"
          markerHeight="10"
          refX="9"
          refY="3"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="0 0, 10 3, 0 6" fill="var(--orbis-blue-strong, #164194)" />
        </marker>
        <marker
          id="arrowhead-edge-anim-reverse"
          markerWidth="10"
          markerHeight="10"
          refX="1"
          refY="3"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="10 0, 0 3, 10 6" fill="var(--orbis-blue-strong, #164194)" />
        </marker>
        <marker
          id="arrowhead-edge-anim-highlight"
          markerWidth="10"
          markerHeight="10"
          refX="9"
          refY="3"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="0 0, 10 3, 0 6" fill="#00a896" />
        </marker>
        <marker
          id="arrowhead-edge-anim-highlight-reverse"
          markerWidth="10"
          markerHeight="10"
          refX="1"
          refY="3"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="10 0, 0 3, 10 6" fill="#00a896" />
        </marker>
      </defs>
      
      <!-- Layer backgrounds (from shared architecture - full view in Steps 3-4) -->
      <g class="layer-backgrounds" *ngIf="currentStep?.showFullArchitecture">
        <ng-container *ngFor="let container of containers">
          <rect
            *ngIf="container.id === 'layer-business' || container.id === 'layer-dsp' || container.id === 'layer-shopfloor'"
            [attr.x]="container.x"
            [attr.y]="container.y"
            [attr.width]="container.width"
            [attr.height]="container.height"
            [attr.fill]="getLayerFill(container.id)"
            [attr.stroke]="getLayerStroke(container.id)"
            stroke-width="1"
            rx="4"
          />
        </ng-container>
      </g>
      
      <!-- External zones (Business and Shopfloor) - simplified zones for Steps 1-2 -->
      <g class="external-zones" *ngIf="!currentStep?.showFullArchitecture">
        <ng-container *ngFor="let container of containers">
          <rect
            *ngIf="(container.id === 'business-zone' || container.id === 'shopfloor-zone') && container.state !== 'hidden'"
            [attr.x]="container.x"
            [attr.y]="container.y"
            [attr.width]="container.width"
            [attr.height]="container.height"
            [attr.class]="'zone zone--' + container.state"
            rx="8"
          />
          <text
            *ngIf="(container.id === 'business-zone' || container.id === 'shopfloor-zone') && container.state !== 'hidden'"
            [attr.x]="container.x + container.width / 2"
            [attr.y]="container.y + container.height / 2"
            class="zone-label"
            text-anchor="middle"
            dominant-baseline="middle"
          >
            {{ container.label }}
          </text>
        </ng-container>
      </g>
      
      <!-- Main EDGE container -->
      <g class="edge-main-container">
        <ng-container *ngFor="let container of containers">
          <rect
            *ngIf="container.id === 'edge-container'"
            [attr.x]="container.x"
            [attr.y]="container.y"
            [attr.width]="container.width"
            [attr.height]="container.height"
            [attr.class]="'edge-container-box edge-container-box--' + container.state"
            rx="12"
          />
          <text
            *ngIf="container.id === 'edge-container' && container.state !== 'hidden'"
            [attr.x]="container.x + 30"
            [attr.y]="container.y + 35"
            class="edge-container-label"
          >
            {{ container.label }}
          </text>
        </ng-container>
      </g>
      
      <!-- Connection lines (drawn before boxes) -->
      <g class="connections">
        <ng-container *ngFor="let conn of connections">
          <line
            *ngIf="conn.state !== 'hidden'"
            [attr.x1]="getConnectionLine(conn).x1"
            [attr.y1]="getConnectionLine(conn).y1"
            [attr.x2]="getConnectionLine(conn).x2"
            [attr.y2]="getConnectionLine(conn).y2"
            [attr.class]="'connection-line connection-line--' + conn.state"
            [attr.marker-end]="conn.state === 'highlight' ? 'url(#arrowhead-edge-anim-highlight)' : 'url(#arrowhead-edge-anim)'"
            [attr.marker-start]="conn.bidirectional ? (conn.state === 'highlight' ? 'url(#arrowhead-edge-anim-highlight-reverse)' : 'url(#arrowhead-edge-anim-reverse)') : null"
          />
        </ng-container>
      </g>
      
      <!-- Architecture containers (Business, Shopfloor, Cloud - from full architecture view in Steps 3-4) -->
      <g class="architecture-containers" *ngIf="currentStep?.showFullArchitecture">
        <ng-container *ngFor="let container of containers">
          <g *ngIf="isArchitectureContainer(container.id) && container.state !== 'hidden'">
            <rect
              [attr.x]="container.x"
              [attr.y]="container.y"
              [attr.width]="container.width"
              [attr.height]="container.height"
              fill="white"
              [attr.stroke]="getContainerStroke(container.id)"
              stroke-width="2"
              rx="8"
            />
            <text
              [attr.x]="container.x + container.width / 2"
              [attr.y]="container.y + 30"
              text-anchor="middle"
              class="architecture-container-label"
            >
              {{ getContainerDisplayName(container.id) }}
            </text>
          </g>
        </ng-container>
      </g>
      
      <!-- Component boxes (Edge components) -->
      <g class="component-boxes">
        <ng-container *ngFor="let container of containers">
          <g
            *ngIf="isEdgeComponent(container.id) && container.state !== 'hidden'"
            [attr.class]="'component-box component-box--' + container.state"
          >
          <rect
            [attr.x]="getScaledX(container)"
            [attr.y]="getScaledY(container)"
            [attr.width]="getScaledWidth(container)"
            [attr.height]="getScaledHeight(container)"
            [attr.class]="'component-box__rect component-box__rect--' + container.state"
            rx="6"
          />
          <!-- Icon (center-top) using foreignObject to embed HTML img -->
          <foreignObject
            *ngIf="container.icon"
            [attr.x]="getScaledX(container) + (getScaledWidth(container) - getScaledIconSize(container)) / 2"
            [attr.y]="getScaledY(container) + (currentStep?.showFullArchitecture ? 3 : 10)"
            [attr.width]="getScaledIconSize(container)"
            [attr.height]="getScaledIconSize(container)"
            class="component-box__icon-container"
          >
            <div xmlns="http://www.w3.org/1999/xhtml" class="component-box__icon-wrapper">
              <img
                [src]="container.icon"
                [alt]="container.label + ' icon'"
                class="component-box__icon"
              />
            </div>
          </foreignObject>
          <!-- Label (center-bottom, below icon) -->
          <text
            [attr.x]="getScaledX(container) + getScaledWidth(container) / 2"
            [attr.y]="getScaledY(container) + getScaledHeight(container) - (currentStep?.showFullArchitecture ? 6 : 15)"
            class="component-box__label"
            [attr.font-size]="currentStep?.showFullArchitecture ? '8' : '11'"
            text-anchor="middle"
            dominant-baseline="middle"
          >
            {{ container.label }}
          </text>
        </g>
        </ng-container>
      </g>
    </svg>
  </div>
</div>
