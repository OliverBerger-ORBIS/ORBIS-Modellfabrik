<div class="dsp-architecture">
  <!-- Header with title and zoom controls -->
  <header class="dsp-architecture__header">
    <div class="header__title">
      <h2>{{ title }}</h2>
      <p class="subtitle">{{ subtitle }}</p>
    </div>
    <div class="header__zoom">
      <button
        type="button"
        class="zoom-btn"
        (click)="zoomOut()"
        [disabled]="zoom <= minZoom"
        [attr.title]="zoomOutLabel"
        [attr.aria-label]="zoomOutLabel"
      >
        −
      </button>
      <span class="zoom-level">{{ (zoom * 100) | number:'1.0-0' }}%</span>
      <button
        type="button"
        class="zoom-btn"
        (click)="zoomIn()"
        [disabled]="zoom >= maxZoom"
        [attr.title]="zoomInLabel"
        [attr.aria-label]="zoomInLabel"
      >
        +
      </button>
      <button
        type="button"
        class="zoom-btn zoom-btn--reset"
        (click)="resetZoom()"
        [attr.title]="resetZoomLabel"
        [attr.aria-label]="resetZoomLabel"
      >
        ↺
      </button>
    </div>
  </header>

  <!-- SVG Diagram - wrapped in scrollable container -->
  <div class="dsp-architecture__diagram-wrapper">
    <div class="dsp-architecture__diagram" [style.transform]="'scale(' + zoom + ')'">
    <svg
      [attr.viewBox]="'0 0 ' + viewBoxWidth + ' ' + viewBoxHeight"
      preserveAspectRatio="xMidYMid meet"
      class="diagram-svg"
      role="img"
      [attr.aria-label]="title"
    >
      <!-- Defs for markers (arrows) and gradients -->
      <defs>
        <!-- Gradient for shopfloor device containers -->
        <linearGradient id="shopfloor-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:var(--neutral-lightgrey);stop-opacity:1" />
          <stop offset="100%" style="stop-color:var(--orbis-grey-light);stop-opacity:1" />
        </linearGradient>
        <marker
          id="arrow-head"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="0 0, 10 3.5, 0 7" fill="var(--orbis-blue-light)" />
        </marker>
        <marker
          id="arrow-head-highlight"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="0 0, 10 3.5, 0 7" fill="var(--microsoft-orange-medium)" />
        </marker>
        <marker
          id="arrow-head-small"
          markerWidth="7.5"
          markerHeight="5.25"
          refX="6.75"
          refY="2.625"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="0 0, 7.5 2.625, 0 5.25" fill="var(--orbis-blue-light)" />
        </marker>
        <marker
          id="arrow-head-small-highlight"
          markerWidth="7.5"
          markerHeight="5.25"
          refX="6.75"
          refY="2.625"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="0 0, 7.5 2.625, 0 5.25" fill="var(--microsoft-orange-medium)" />
        </marker>
        <marker
          id="arrow-head-reverse"
          markerWidth="10"
          markerHeight="7"
          refX="1"
          refY="3.5"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="10 0, 0 3.5, 10 7" fill="var(--orbis-blue-light)" />
        </marker>
        <marker
          id="arrow-head-reverse-highlight"
          markerWidth="10"
          markerHeight="7"
          refX="1"
          refY="3.5"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="10 0, 0 3.5, 10 7" fill="var(--microsoft-orange-medium)" />
        </marker>
        <marker
          id="arrow-head-reverse-small"
          markerWidth="7.5"
          markerHeight="5.25"
          refX="0.75"
          refY="2.625"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="7.5 0, 0 2.625, 7.5 5.25" fill="var(--orbis-blue-light)" />
        </marker>
        <marker
          id="arrow-head-reverse-small-highlight"
          markerWidth="7.5"
          markerHeight="5.25"
          refX="0.75"
          refY="2.625"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="7.5 0, 0 2.625, 7.5 5.25" fill="var(--microsoft-orange-medium)" />
        </marker>
      </defs>

      <!-- Layer backgrounds (drawn first, at bottom z-level) -->
      <g class="layer-backgrounds">
        <ng-container *ngFor="let container of containers; trackBy: containerTrackBy">
          <g
            *ngIf="isContainerVisible(container) && container.type === 'layer'"
            [attr.transform]="'translate(' + container.x + ',' + container.y + ')'"
          >
            <!-- Layer background rect -->
            <rect
              [attr.width]="container.width"
              [attr.height]="container.height"
              [attr.fill]="getContainerFill(container)"
              [attr.stroke]="getContainerStroke(container)"
              [attr.stroke-width]="1"
              rx="0"
              ry="0"
              class="layer__bg"
            />
            <!-- Layer label (upper left corner) - increased font size -->
            <text
              *ngIf="getContainerLabel(container.id)"
              [attr.x]="20"
              [attr.y]="20"
              text-anchor="start"
              dominant-baseline="hanging"
              [attr.font-size]="18"
              font-weight="600"
              fill="var(--orbis-nightblue)"
              class="layer__label"
            >
              {{ getContainerLabel(container.id) }}
            </text>
          </g>
        </ng-container>
      </g>

      <!-- Containers (middle z-level) -->
      <g class="containers">
        <ng-container *ngFor="let container of containers; trackBy: containerTrackBy">
          <g
            *ngIf="isContainerVisible(container) && container.type !== 'layer'"
            [class]="getContainerClass(container)"
            [attr.transform]="'translate(' + container.x + ',' + container.y + ')'"
            (click)="onContainerClick(container)"
            (keydown)="onContainerKeydown($event, container)"
            [attr.tabindex]="container.type !== 'label' ? 0 : null"
            [attr.role]="container.type !== 'label' ? 'button' : null"
          >
            <!-- Container background -->
            <ng-container [ngSwitch]="container.type">
              <polygon
                *ngSwitchCase="'pipeline'"
                [attr.points]="getPipelinePoints(container)"
                [attr.fill]="getContainerFill(container)"
                [attr.stroke]="getContainerStroke(container)"
                [attr.stroke-width]="getContainerStrokeWidth(container)"
                class="container__bg"
              />
              <rect
                *ngSwitchDefault
                [attr.width]="container.width"
                [attr.height]="container.height"
                [attr.fill]="getContainerFill(container)"
                [attr.stroke]="getContainerStroke(container)"
                [attr.stroke-width]="getContainerStrokeWidth(container)"
                [attr.rx]="container.isGroup ? 16 : 8"
                [attr.ry]="container.isGroup ? 16 : 8"
                class="container__bg"
              />
            </ng-container>

            <!-- Logo (top-left) for ALL DSP containers (ux, dsp-edge, dsp-cloud) - same position and size (48px) -->
            <image
              *ngIf="container.logoIconKey && container.logoPosition === 'top-left' && (container.type === 'ux' || container.type === 'dsp-edge' || container.type === 'dsp-cloud')"
              [attr.href]="resolveIconPath(container.logoIconKey)"
              [attr.x]="12"
              [attr.y]="12"
              width="48"
              height="48"
              class="container__logo container__logo--dsp"
            />

            <!-- Logo (top-left) for non-DSP, non-device containers -->
            <image
              *ngIf="container.logoIconKey && container.logoPosition === 'top-left' && container.type !== 'device' && container.type !== 'ux' && container.type !== 'dsp-edge' && container.type !== 'dsp-cloud'"
              [attr.href]="resolveIconPath(container.logoIconKey)"
              [attr.x]="8"
              [attr.y]="8"
              width="28"
              height="28"
              class="container__logo"
            />

            <!-- Secondary Logos (supports multiple, positional override) -->
            <ng-container *ngIf="getSecondaryLogos(container).length > 0">
              <image
                *ngFor="let logo of getSecondaryLogos(container); let i = index"
                [attr.href]="resolveIconPath(logo)"
                [attr.x]="getSecondaryLogoX(container, i)"
                [attr.y]="8"
                [attr.width]="getSecondaryLogoSize(container)"
                [attr.height]="getSecondaryLogoSize(container)"
                class="container__logo container__logo--secondary"
              />
            </ng-container>

            <!-- Device/System Icon (centered at top, with label below) - larger icons -->
            <image
              *ngIf="container.type === 'device' && container.logoIconKey"
              [attr.href]="resolveIconPath(container.logoIconKey)"
              [attr.x]="(container.width - getDeviceIconSize(container)) / 2"
              [attr.y]="12"
              [attr.width]="getDeviceIconSize(container)"
              [attr.height]="getDeviceIconSize(container)"
              class="container__device-icon"
            />

            <!-- Function Icons (centered in row) - only shown when step allows -->
            <g *ngIf="getVisibleFunctionIcons(container).length > 0 && shouldShowFunctionIcons()" class="container__icons">
              <ng-container *ngFor="let icon of getVisibleFunctionIcons(container); let i = index; trackBy: iconTrackBy">
                <image
                  [attr.href]="resolveIconPath(icon.iconKey)"
                  [attr.x]="getFunctionIconPosition(container, i, { iconKey: icon.iconKey, size: getFunctionIconSize(icon.iconKey) }).x"
                  [attr.y]="getFunctionIconPosition(container, i, { iconKey: icon.iconKey, size: getFunctionIconSize(icon.iconKey) }).y"
                  [attr.width]="getFunctionIconSize(icon.iconKey)"
                  [attr.height]="getFunctionIconSize(icon.iconKey)"
                  [class.container__function-icon]="!isFunctionIconHighlighted(icon.iconKey)"
                  [class.container__function-icon--highlighted]="isFunctionIconHighlighted(icon.iconKey)"
                />
                <line
                  *ngIf="container.id === 'dsp-mc' && steps[currentStepIndex]?.id === 'step-18' && icon.iconKey.startsWith('logo-edge-')"
                  [attr.x1]="container.width / 2"
                  [attr.y1]="container.height / 2"
                  [attr.x2]="getFunctionIconCenter(container, i, { iconKey: icon.iconKey, size: getFunctionIconSize(icon.iconKey) }).cx"
                  [attr.y2]="getFunctionIconCenter(container, i, { iconKey: icon.iconKey, size: getFunctionIconSize(icon.iconKey) }).cy"
                  stroke="var(--microsoft-orange-medium)"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-dasharray="4 4"
                />
              </ng-container>
            </g>

            <!-- Center Icon (for ux, dsp-edge, dsp-mc) - using centerIconKey -->
            <image
              *ngIf="(container.type === 'ux' || container.id === 'dsp-edge' || container.id === 'dsp-mc') && container.centerIconKey"
              [attr.href]="resolveIconPath(container.centerIconKey)"
              [attr.x]="(container.width - 84) / 2"
              [attr.y]="(container.height - 84) / 2"
              width="84"
              height="84"
              class="container__ux-icon"
            />

            <!-- Environment labels (above DSP containers) - displayed as property, not separate container -->
            <text
              *ngIf="container.environmentLabel && (container.type === 'dsp-edge' || container.type === 'dsp-cloud')"
              [attr.x]="0"
              [attr.y]="-7"
              text-anchor="start"
              font-size="14"
              font-weight="600"
              fill="var(--orbis-nightblue)"
              class="environment__label"
            >
              {{ container.environmentLabel }}
            </text>

            <!-- DSP Container labels at top center (aligned with logo height) -->
            <text
              *ngIf="getContainerLabel(container.id) && (container.type === 'ux' || container.type === 'dsp-edge' || container.type === 'dsp-cloud') && container.labelPosition === 'top-center'"
              [attr.x]="getLabelX(container)"
              [attr.y]="getLabelY(container)"
              [attr.text-anchor]="getLabelAnchor(container)"
              [attr.font-size]="container.fontSize || 16"
              [attr.fill]="container.textColor || 'var(--orbis-nightblue)'"
              font-weight="600"
              dominant-baseline="middle"
              class="container__label container__label--dsp"
            >
              <ng-container *ngIf="isMultilineLabel(container.id)">
                <ng-container *ngFor="let line of getMultilineLabel(container.id); let i = index">
                  <tspan [attr.x]="getLabelX(container)" [attr.dy]="i === 0 ? '0' : '1.2em'">{{ line }}</tspan>
                </ng-container>
              </ng-container>
              <ng-container *ngIf="!isMultilineLabel(container.id)">
                {{ getContainerLabel(container.id) }}
              </ng-container>
            </text>

            <!-- Label - positioned based on labelPosition -->
            <!-- Exclude DSP, shopfloor-group, business, and device containers with bottom-center as they have separate label elements -->
            <text
              *ngIf="getContainerLabel(container.id) && container.type !== 'environment-label' && container.type !== 'device' && container.type !== 'shopfloor-group' && !(container.type === 'ux' || container.type === 'dsp-edge' || container.type === 'dsp-cloud') && !((container.type === 'shopfloor' || container.type === 'business') && container.labelPosition === 'bottom-center')"
              [attr.x]="getLabelX(container)"
              [attr.y]="getLabelY(container)"
              [attr.text-anchor]="getLabelAnchor(container)"
              [attr.font-size]="container.fontSize || 12"
              [attr.fill]="container.textColor || 'var(--orbis-nightblue)'"
              [attr.font-weight]="container.type === 'label' ? 600 : 500"
              [attr.dominant-baseline]="container.type === 'pipeline' ? 'middle' : 'auto'"
              class="container__label"
            >
              <ng-container *ngIf="isMultilineLabel(container.id)">
                <ng-container *ngFor="let line of getMultilineLabel(container.id); let i = index">
                  <tspan [attr.x]="getLabelX(container)" [attr.dy]="i === 0 ? '0' : '1.2em'">{{ line }}</tspan>
                </ng-container>
              </ng-container>
              <ng-container *ngIf="!isMultilineLabel(container.id) && shouldWrapLabel(container)">
                <ng-container *ngFor="let line of getWrappedLabelLines(container); let i = index">
                  <tspan [attr.x]="getLabelX(container)" [attr.dy]="i === 0 ? '0' : '1.2em'">{{ line }}</tspan>
                </ng-container>
              </ng-container>
              <ng-container *ngIf="!isMultilineLabel(container.id) && !shouldWrapLabel(container)">
                {{ getContainerLabel(container.id) }}
              </ng-container>
            </text>

            <!-- Device/System labels at bottom - allow multi-line if needed -->
            <text
              *ngIf="container.type === 'device' && getContainerLabel(container.id)"
              [attr.x]="container.width / 2"
              [attr.y]="container.height - 8"
              text-anchor="middle"
              dominant-baseline="baseline"
              [attr.font-size]="container.fontSize || 12"
              font-weight="500"
              fill="var(--orbis-nightblue)"
              class="container__device-label"
            >
              <ng-container *ngIf="shouldWrapLabel(container)">
                <ng-container *ngFor="let line of getWrappedLabelLines(container); let i = index">
                  <tspan [attr.x]="container.width / 2" [attr.dy]="i === 0 ? (-(getWrappedLabelLines(container).length - 1) * container.fontSize!) + 'px' : '1.2em'">{{ line }}</tspan>
                </ng-container>
              </ng-container>
              <ng-container *ngIf="!shouldWrapLabel(container)">
                {{ getContainerLabel(container.id) }}
              </ng-container>
            </text>

            <!-- Shopfloor group labels inside container at bottom -->
            <text
              *ngIf="container.type === 'shopfloor-group' && container.labelPosition === 'bottom' && getContainerLabel(container.id)"
              [attr.x]="container.width / 2"
              [attr.y]="container.height - 10"
              text-anchor="middle"
              dominant-baseline="baseline"
              [attr.font-size]="container.fontSize || 14"
              font-weight="600"
              fill="var(--orbis-nightblue)"
              class="container__group-label"
            >
              {{ getContainerLabel(container.id) }}
            </text>

            <!-- Business process labels at bottom center -->
            <text
              *ngIf="container.type === 'business' && container.labelPosition === 'bottom-center' && getContainerLabel(container.id)"
              [attr.x]="container.width / 2"
              [attr.y]="container.height - 12"
              text-anchor="middle"
              [attr.font-size]="container.fontSize || 14"
              font-weight="600"
              fill="var(--orbis-nightblue)"
              class="container__group-label"
            >
              {{ getContainerLabel(container.id) }}
            </text>

            <!-- Business process icon (centered, below label) - larger icons like Shopfloor -->
            <image
              *ngIf="container.type === 'business' && container.logoIconKey && !container.logoPosition"
              [attr.href]="resolveIconPath(container.logoIconKey)"
              [attr.x]="(container.width - 70) / 2"
              [attr.y]="35"
              width="70"
              height="70"
              class="container__bp-icon"
            />
          </g>
        </ng-container>
      </g>

      <!-- Step Description Overlay (displayed prominently in the diagram) -->
      <g *ngIf="steps[currentStepIndex].description" class="step-overlay">
        <!-- Semi-transparent background box -->
        <rect
          [attr.x]="20"
          [attr.y]="0"
          [attr.width]="viewBoxWidth - 40"
          [attr.height]="80"
          fill="rgba(var(--highlight-green-strong-rgb), 0.95)"
          rx="8"
          ry="8"
          class="step-overlay__bg"
        />
        <!-- Step title -->
        <text
          [attr.x]="viewBoxWidth / 2"
          [attr.y]="25"
          text-anchor="middle"
          font-size="20"
          font-weight="700"
          fill="#ffffff"
          class="step-overlay__title"
        >
          {{ steps[currentStepIndex].label }}
        </text>
        <!-- Step description -->
        <text
          [attr.x]="viewBoxWidth / 2"
          [attr.y]="52"
          text-anchor="middle"
          font-size="14"
          font-weight="400"
          fill="#ffffff"
          class="step-overlay__description"
        >
          {{ steps[currentStepIndex].description }}
        </text>
      </g>

      <!-- Connections (drawn last, on top of everything) -->
      <g class="connections">
        <ng-container *ngFor="let conn of connections; trackBy: connectionTrackBy">
          <path
            *ngIf="isConnectionVisible(conn)"
            [attr.d]="getConnectionPath(conn)"
            [class]="getConnectionClass(conn)"
            fill="none"
            [attr.stroke]="conn.state === 'highlight' ? 'var(--microsoft-orange-medium)' : 'var(--orbis-blue-light)'"
            [attr.stroke-width]="conn.state === 'highlight' ? 2.5 : 2"
            [attr.marker-end]="conn.hasArrow ? (conn.state === 'highlight'
              ? (isEcConnection(conn) ? 'url(#arrow-head-small-highlight)' : 'url(#arrow-head-highlight)')
              : (isEcConnection(conn) ? 'url(#arrow-head-small)' : 'url(#arrow-head)')) : null"
            [attr.marker-start]="conn.bidirectional ? (conn.state === 'highlight'
              ? (isEcConnection(conn) ? 'url(#arrow-head-reverse-small-highlight)' : 'url(#arrow-head-reverse-highlight)')
              : (isEcConnection(conn) ? 'url(#arrow-head-reverse-small)' : 'url(#arrow-head-reverse)')) : null"
          />
        </ng-container>
      </g>
    </svg>
  </div>
  </div>

  <!-- Navigation Controls -->
  <footer class="dsp-architecture__controls">
    <div class="controls__step-indicator">
      <span class="step-label">
        {{ steps[currentStepIndex].label }} ({{ currentStepIndex + 1 }} / {{ steps.length }})
      </span>
    </div>
    <div class="controls__buttons">
      <button
        type="button"
        class="nav-btn"
        (click)="prevStep()"
        [disabled]="currentStepIndex === 0"
      >
        {{ btnPrev }}
      </button>
      <button
        type="button"
        class="nav-btn nav-btn--primary"
        (click)="toggleAutoPlay()"
      >
        {{ isAutoPlaying ? btnStopPlay : btnAutoPlay }}
      </button>
      <button
        type="button"
        class="nav-btn"
        (click)="toggleLoop()"
        [class.nav-btn--primary]="loopToStart"
        [attr.aria-pressed]="loopToStart"
      >
        Loop {{ loopToStart ? 'On' : 'Off' }}
      </button>
      <button
        type="button"
        class="nav-btn"
        (click)="nextStep()"
        [disabled]="currentStepIndex === steps.length - 1"
      >
        {{ btnNext }}
      </button>
    </div>
    <div class="controls__step-dots">
      <button
        *ngFor="let step of steps; let i = index"
        type="button"
        class="step-dot"
        [class.step-dot--active]="i === currentStepIndex"
        [class.step-dot--completed]="i < currentStepIndex"
        (click)="goToStep(i)"
        [attr.aria-label]="step.label"
        [attr.title]="step.label"
      ></button>
    </div>
  </footer>

</div>
