<div class="dsp-architecture">
  <!-- Header with title and zoom controls -->
  <header class="dsp-architecture__header">
    <div class="header__title">
      <h2>{{ title }}</h2>
      <p class="subtitle">{{ subtitle }}</p>
    </div>
    <div class="header__zoom">
      <button
        type="button"
        class="zoom-btn"
        (click)="zoomOut()"
        [disabled]="zoom <= minZoom"
        title="Zoom out"
        aria-label="Zoom out"
      >
        −
      </button>
      <span class="zoom-level">{{ (zoom * 100) | number:'1.0-0' }}%</span>
      <button
        type="button"
        class="zoom-btn"
        (click)="zoomIn()"
        [disabled]="zoom >= maxZoom"
        title="Zoom in"
        aria-label="Zoom in"
      >
        +
      </button>
      <button
        type="button"
        class="zoom-btn zoom-btn--reset"
        (click)="resetZoom()"
        title="Reset zoom"
        aria-label="Reset zoom"
      >
        ↺
      </button>
    </div>
  </header>

  <!-- SVG Diagram - wrapped in scrollable container -->
  <div class="dsp-architecture__diagram-wrapper">
    <div class="dsp-architecture__diagram" [style.transform]="'scale(' + zoom + ')'">
    <svg
      [attr.viewBox]="'0 0 ' + viewBoxWidth + ' ' + viewBoxHeight"
      preserveAspectRatio="xMidYMid meet"
      class="diagram-svg"
      role="img"
      [attr.aria-label]="title"
    >
      <!-- Defs for markers (arrows) -->
      <defs>
        <marker
          id="arrow-head"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="0 0, 10 3.5, 0 7" fill="#7f8da5" />
        </marker>
        <marker
          id="arrow-head-highlight"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="0 0, 10 3.5, 0 7" fill="#ff9900" />
        </marker>
        <marker
          id="arrow-head-reverse"
          markerWidth="10"
          markerHeight="7"
          refX="1"
          refY="3.5"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="10 0, 0 3.5, 10 7" fill="#7f8da5" />
        </marker>
        <marker
          id="arrow-head-reverse-highlight"
          markerWidth="10"
          markerHeight="7"
          refX="1"
          refY="3.5"
          orient="auto"
          markerUnits="strokeWidth"
        >
          <polygon points="10 0, 0 3.5, 10 7" fill="#ff9900" />
        </marker>
      </defs>

      <!-- Layer backgrounds (drawn first, at bottom z-level) -->
      <g class="layer-backgrounds">
        <ng-container *ngFor="let container of containers; trackBy: containerTrackBy">
          <g
            *ngIf="isContainerVisible(container) && container.type === 'layer'"
            [attr.transform]="'translate(' + container.x + ',' + container.y + ')'"
          >
            <!-- Layer background rect -->
            <rect
              [attr.width]="container.width"
              [attr.height]="container.height"
              [attr.fill]="getContainerFill(container)"
              [attr.stroke]="getContainerStroke(container)"
              [attr.stroke-width]="1"
              rx="0"
              ry="0"
              class="layer__bg"
            />
            <!-- Layer label (left side, vertically centered, multi-line support) -->
            <text
              *ngIf="getContainerLabel(container.id)"
              [attr.x]="20"
              [attr.y]="container.height / 2 - 10"
              text-anchor="start"
              dominant-baseline="middle"
              font-size="14"
              font-weight="600"
              fill="#1e2d3d"
              class="layer__label"
            >
              <ng-container *ngFor="let line of getMultilineLabel(container.id); let i = index">
                <tspan [attr.x]="20" [attr.dy]="i === 0 ? '0' : '1.2em'">{{ line }}</tspan>
              </ng-container>
            </text>
          </g>
        </ng-container>
      </g>

      <!-- Containers (middle z-level) -->
      <g class="containers">
        <ng-container *ngFor="let container of containers; trackBy: containerTrackBy">
          <g
            *ngIf="isContainerVisible(container) && container.type !== 'layer'"
            [class]="getContainerClass(container)"
            [attr.transform]="'translate(' + container.x + ',' + container.y + ')'"
            (click)="onContainerClick(container)"
            (keydown)="onContainerKeydown($event, container)"
            [attr.tabindex]="container.type !== 'label' ? 0 : null"
            [attr.role]="container.type !== 'label' ? 'button' : null"
          >
            <!-- Container background -->
            <rect
              *ngIf="container.type !== 'label'"
              [attr.width]="container.width"
              [attr.height]="container.height"
              [attr.fill]="getContainerFill(container)"
              [attr.stroke]="getContainerStroke(container)"
              [attr.stroke-width]="getContainerStrokeWidth(container)"
              [attr.rx]="container.isGroup ? 16 : 8"
              [attr.ry]="container.isGroup ? 16 : 8"
              class="container__bg"
            />

            <!-- Logo (top-left) for non-device containers -->
            <image
              *ngIf="container.logoIconKey && container.logoPosition === 'top-left' && container.type !== 'device' && container.type !== 'ux'"
              [attr.href]="resolveIconPath(container.logoIconKey)"
              [attr.x]="8"
              [attr.y]="8"
              width="28"
              height="28"
              class="container__logo"
            />

            <!-- Secondary Logo (top-right) -->
            <image
              *ngIf="container.secondaryLogoIconKey"
              [attr.href]="resolveIconPath(container.secondaryLogoIconKey)"
              [attr.x]="container.width - 36"
              [attr.y]="8"
              width="28"
              height="28"
              class="container__logo container__logo--secondary"
            />

            <!-- Device/System Icon (centered, with label below) -->
            <image
              *ngIf="container.type === 'device' && container.logoIconKey"
              [attr.href]="resolveIconPath(container.logoIconKey)"
              [attr.x]="(container.width - 50) / 2"
              [attr.y]="8"
              width="50"
              height="50"
              class="container__device-icon"
            />

            <!-- Function Icons (centered in row) -->
            <g
              *ngIf="container.functionIcons && container.functionIcons.length > 0"
              class="container__icons"
            >
              <ng-container *ngFor="let icon of container.functionIcons; let i = index; trackBy: iconTrackBy">
                <image
                  [attr.href]="resolveIconPath(icon.iconKey)"
                  [attr.x]="(container.width / 2) - ((container.functionIcons!.length * (icon.size + 8)) / 2) + (i * (icon.size + 8)) + 4"
                  [attr.y]="(container.height / 2) - (icon.size / 2) + 5"
                  [attr.width]="icon.size"
                  [attr.height]="icon.size"
                  class="container__function-icon"
                />
              </ng-container>
            </g>

            <!-- UX Icon (for ux type containers) -->
            <image
              *ngIf="container.type === 'ux' && container.logoIconKey"
              [attr.href]="resolveIconPath(container.logoIconKey)"
              [attr.x]="(container.width - 55) / 2"
              [attr.y]="15"
              width="55"
              height="55"
              class="container__ux-icon"
            />

            <!-- Label - positioned based on labelPosition -->
            <!-- Exclude shopfloor containers with bottom-center as they have a separate label element -->
            <text
              *ngIf="getContainerLabel(container.id) && !(container.type === 'shopfloor' && container.labelPosition === 'bottom-center')"
              [attr.x]="getLabelX(container)"
              [attr.y]="getLabelY(container)"
              [attr.text-anchor]="getLabelAnchor(container)"
              [attr.font-size]="container.fontSize || 12"
              [attr.fill]="container.textColor || '#1e2d3d'"
              [attr.font-weight]="container.type === 'label' ? 600 : 500"
              class="container__label"
            >
              <ng-container *ngIf="isMultilineLabel(container.id)">
                <ng-container *ngFor="let line of getMultilineLabel(container.id); let i = index">
                  <tspan [attr.x]="getLabelX(container)" [attr.dy]="i === 0 ? '0' : '1.2em'">{{ line }}</tspan>
                </ng-container>
              </ng-container>
              <ng-container *ngIf="!isMultilineLabel(container.id)">
                {{ getContainerLabel(container.id) }}
              </ng-container>
            </text>

            <!-- Shopfloor group labels at bottom center -->
            <text
              *ngIf="container.type === 'shopfloor' && container.labelPosition === 'bottom-center'"
              [attr.x]="container.width / 2"
              [attr.y]="container.height - 12"
              text-anchor="middle"
              [attr.font-size]="container.fontSize || 14"
              font-weight="600"
              fill="#1e2d3d"
              class="container__group-label"
            >
              {{ getContainerLabel(container.id) }}
            </text>

            <!-- Business process icon (centered, below label) -->
            <image
              *ngIf="container.type === 'business' && container.logoIconKey && !container.logoPosition"
              [attr.href]="resolveIconPath(container.logoIconKey)"
              [attr.x]="(container.width - 50) / 2"
              [attr.y]="35"
              width="50"
              height="50"
              class="container__bp-icon"
            />
          </g>
        </ng-container>
      </g>

      <!-- Connections (drawn last, on top of everything) -->
      <g class="connections">
        <ng-container *ngFor="let conn of connections; trackBy: connectionTrackBy">
          <path
            *ngIf="isConnectionVisible(conn)"
            [attr.d]="getConnectionPath(conn)"
            [class]="getConnectionClass(conn)"
            fill="none"
            [attr.stroke]="conn.state === 'highlight' ? '#ff9900' : '#7f8da5'"
            [attr.stroke-width]="conn.state === 'highlight' ? 2.5 : 2"
            [attr.marker-end]="conn.hasArrow ? (conn.state === 'highlight' ? 'url(#arrow-head-highlight)' : 'url(#arrow-head)') : null"
            [attr.marker-start]="conn.bidirectional ? (conn.state === 'highlight' ? 'url(#arrow-head-reverse-highlight)' : 'url(#arrow-head-reverse)') : null"
          />
        </ng-container>
      </g>
    </svg>
  </div>
  </div>

  <!-- Navigation Controls -->
  <footer class="dsp-architecture__controls">
    <div class="controls__step-indicator">
      <span class="step-label">{{ steps[currentStepIndex].label }}</span>
      <span class="step-count">({{ currentStepIndex + 1 }} / {{ steps.length }})</span>
    </div>
    <div class="controls__buttons">
      <button
        type="button"
        class="nav-btn"
        (click)="prevStep()"
        [disabled]="currentStepIndex === 0"
      >
        {{ btnPrev }}
      </button>
      <button
        type="button"
        class="nav-btn nav-btn--primary"
        (click)="toggleAutoPlay()"
      >
        {{ isAutoPlaying ? btnStopPlay : btnAutoPlay }}
      </button>
      <button
        type="button"
        class="nav-btn"
        (click)="nextStep()"
        [disabled]="currentStepIndex === steps.length - 1"
      >
        {{ btnNext }}
      </button>
    </div>
    <div class="controls__step-dots">
      <button
        *ngFor="let step of steps; let i = index"
        type="button"
        class="step-dot"
        [class.step-dot--active]="i === currentStepIndex"
        [class.step-dot--completed]="i < currentStepIndex"
        (click)="goToStep(i)"
        [attr.aria-label]="step.label"
        [attr.title]="step.label"
      ></button>
    </div>
  </footer>
</div>
