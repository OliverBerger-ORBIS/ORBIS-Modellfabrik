<div class="preview" *ngIf="viewModel as vm">
  <header class="preview__header">
    <strong>{{ badgeLabel }}</strong>
    <span>{{ infoLabel }}</span>
  </header>

  <div class="preview__zoom-controls" *ngIf="showZoomControls">
    <button
      type="button"
      class="preview__zoom-button"
      (click)="zoomOut()"
      [disabled]="!canZoomOut"
      [attr.aria-label]="zoomOutLabel"
      [attr.title]="zoomOutLabel"
    >
      âˆ’
    </button>
    <span class="preview__zoom-level">{{ (currentScale * 100) | number:'1.0-0' }}%</span>
    <button
      type="button"
      class="preview__zoom-button"
      (click)="zoomIn()"
      [disabled]="!canZoomIn"
      [attr.aria-label]="zoomInLabel"
      [attr.title]="zoomInLabel"
    >
      +
    </button>
    <button
      type="button"
      class="preview__zoom-button preview__zoom-button--reset"
      (click)="resetZoom()"
      [attr.aria-label]="resetZoomLabel"
      [attr.title]="resetZoomLabel"
    >
      â†º
    </button>
  </div>

  <div class="preview__canvas-wrapper" [style.width.px]="vm.width * currentScale" [style.height.px]="vm.height * currentScale">
    <div
      class="preview__canvas"
      [style.width.px]="vm.width"
      [style.height.px]="vm.height"
      [style.transform]="'scale(' + currentScale + ')'"
    >
      <svg class="preview__roads" [attr.width]="vm.width" [attr.height]="vm.height" *ngIf="vm.roads.length">
        <line
          *ngFor="let road of vm.roads"
          [attr.x1]="road.x1"
          [attr.y1]="road.y1"
          [attr.x2]="road.x2"
          [attr.y2]="road.y2"
        />
      </svg>

      <ng-container *ngFor="let fixed of vm.fixedPositions">
        <div
          class="preview__fixed"
          [class.preview__element--highlight]="fixed.highlighted"
          [class.preview__element--selectable]="selectionEnabled"
          [class.preview__fixed--label-right]="fixed.labelPosition === 'right'"
          [class.preview__fixed--label-left]="fixed.labelPosition === 'left'"
          [style.top.px]="fixed.top"
          [style.left.px]="fixed.left"
          [style.width.px]="fixed.width"
          [style.height.px]="fixed.height"
          [style.background]="fixed.background"
          role="button"
          tabindex="0"
          (click)="onFixedActivate(fixed, $event)"
          (keydown.enter)="onFixedActivate(fixed, $event)"
          (keydown.space)="onFixedActivate(fixed, $event)"
          (dblclick)="onFixedDouble(fixed, $event)"
        >
          <img *ngIf="fixed.icon" [src]="fixed.icon" [alt]="fixed.label" />
          <span *ngIf="fixed.showLabel" class="preview__module-label preview__fixed-label">{{ fixed.label }}</span>
        </div>
      </ng-container>

      <ng-container *ngFor="let module of vm.modules">
        <div
          class="preview__module"
          [class.preview__element--highlight]="module.highlighted"
          [class.preview__element--selectable]="selectionEnabled"
          [class.preview__module--connected]="module.status?.connected"
          [class.preview__module--disconnected]="module.status && !module.status.connected"
          [class.preview__module--available]="module.status?.availability === 'READY'"
          [class.preview__module--busy]="module.status?.availability === 'BUSY'"
          [class.preview__module--blocked]="module.status?.availability === 'BLOCKED'"
          [class.preview__module--unknown]="isUnknownAvailability(module.status?.availability)"
          [style.top.px]="module.top"
          [style.left.px]="module.left"
          [style.width.px]="module.width"
          [style.height.px]="module.height"
          [style.background-color]="getModuleBackgroundColor(module.status?.availability)"
          role="button"
          tabindex="0"
          (click)="onModuleActivate(module, $event)"
          (keydown.enter)="onModuleActivate(module, $event)"
          (keydown.space)="onModuleActivate(module, $event)"
          (dblclick)="onModuleDouble(module, $event)"
        >
          <img
            *ngIf="module.icon"
            class="preview__module-icon"
            [src]="module.icon"
            [alt]="module.label"
            [style.top.px]="module.iconTop"
            [style.left.px]="module.iconLeft"
            [style.width.px]="module.iconWidth"
            [style.height.px]="module.iconHeight"
          />
          <img
            *ngFor="let attachment of module.attachments"
            class="preview__attached"
            [style.top.px]="attachment.top"
            [style.left.px]="attachment.left"
            [style.width.px]="attachment.width"
            [style.height.px]="attachment.height"
            [src]="attachment.icon"
            alt=""
          />
          <!-- Status Overlays -->
          <div *ngIf="module.status" class="preview__module-status-overlay">
            <!-- Connected/Disconnected icon in top-left corner -->
            <span *ngIf="module.status.connected" class="preview__status-badge preview__status-badge--connected" title="Connected">ðŸ“¶</span>
            <span *ngIf="module.status.connected === false" class="preview__status-badge preview__status-badge--disconnected" title="Disconnected">ðŸš«</span>
          </div>
          <!-- Availability status in top-right corner -->
          <div *ngIf="module.status" class="preview__module-availability-overlay">
            <span *ngIf="module.status.availability === 'READY'" class="preview__status-badge preview__status-badge--available" title="Available">ðŸŸ¢</span>
            <span *ngIf="module.status.availability === 'BUSY'" class="preview__status-badge preview__status-badge--busy" title="Busy">ðŸŸ </span>
            <span *ngIf="module.status.availability === 'BLOCKED'" class="preview__status-badge preview__status-badge--blocked" title="Blocked">ðŸ”´</span>
            <span *ngIf="isUnknownAvailability(module.status?.availability)" class="preview__status-badge preview__status-badge--unknown" title="Unknown">âš«</span>
          </div>
          <span *ngIf="module.showLabel" class="preview__module-label">{{ module.label }}</span>
        </div>
      </ng-container>

      <div
        *ngFor="let node of vm.intersections"
        class="preview__intersection"
        [style.top.px]="node.top"
        [style.left.px]="node.left"
        [style.width.px]="node.width"
        [style.height.px]="node.height"
      >
        <img
          *ngIf="node.icon"
          class="preview__intersection-icon"
          [src]="node.icon"
          alt=""
          [style.width.%]="node.iconScale * 100"
          [style.height.%]="node.iconScale * 100"
        />
        <span *ngIf="!node.icon" class="preview__intersection-dot"></span>
      </div>

      <svg
        *ngIf="vm.activeRouteSegments?.length"
        class="preview__route-overlay"
        [attr.width]="vm.width"
        [attr.height]="vm.height"
      >
        <line
          *ngFor="let segment of vm.activeRouteSegments"
          [attr.x1]="segment.x1"
          [attr.y1]="segment.y1"
          [attr.x2]="segment.x2"
          [attr.y2]="segment.y2"
        />
      </svg>

      <!-- FTS Icon: Use inline SVG with orange fill if available, otherwise fallback to img -->
      <!-- FTS from active route -->
      <div
        *ngIf="vm.routeOverlay && vm.routeOverlay.svgContent"
        class="preview__fts preview__fts--inline"
        [style.left.px]="vm.routeOverlay.x"
        [style.top.px]="vm.routeOverlay.y"
        [style.width.px]="vm.routeOverlay.width ?? 48"
        [style.height.px]="vm.routeOverlay.height ?? 48"
        [innerHTML]="vm.routeOverlay.svgContent"
      ></div>
      <img
        *ngIf="vm.routeOverlay && !vm.routeOverlay.svgContent"
        class="preview__fts"
        [src]="vm.routeOverlay.icon"
        alt=""
        [style.left.px]="vm.routeOverlay.x"
        [style.top.px]="vm.routeOverlay.y"
        [style.width.px]="vm.routeOverlay.width ?? 48"
        [style.height.px]="vm.routeOverlay.height ?? 48"
      />
      <!-- FTS from position (when no active route) -->
      <div
        *ngIf="vm.ftsOverlay && vm.ftsOverlay.svgContent"
        class="preview__fts preview__fts--inline"
        [style.left.px]="vm.ftsOverlay.x"
        [style.top.px]="vm.ftsOverlay.y"
        [style.width.px]="vm.ftsOverlay.width ?? 48"
        [style.height.px]="vm.ftsOverlay.height ?? 48"
        [innerHTML]="vm.ftsOverlay.svgContent"
      ></div>
      <img
        *ngIf="vm.ftsOverlay && !vm.ftsOverlay.svgContent"
        class="preview__fts"
        [src]="vm.ftsOverlay.icon"
        alt=""
        [style.left.px]="vm.ftsOverlay.x"
        [style.top.px]="vm.ftsOverlay.y"
        [style.width.px]="vm.ftsOverlay.width ?? 48"
        [style.height.px]="vm.ftsOverlay.height ?? 48"
      />
    </div>
  </div>
</div>

