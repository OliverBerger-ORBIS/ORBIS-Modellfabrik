<div class="shopfloor-demo">
  <header class="demo-header">
    <h2>Shopfloor Layout Demo</h2>
    <div class="controls">
      <label for="scale-slider" class="control-label">
        Scale: <strong>{{ scaleLabel }}</strong>
      </label>
      <input
        id="scale-slider"
        type="range"
        [min]="minScale"
        [max]="maxScale"
        [value]="scale"
        (input)="onScaleChange($event)"
        class="scale-slider"
      />
    </div>
  </header>

  <div *ngIf="loading" class="loading-state">
    <p>Loading shopfloor layout...</p>
  </div>

  <div *ngIf="error" class="error-state">
    <p>Error: {{ error }}</p>
  </div>

  <div *ngIf="renderModel && !loading && !error" class="canvas-container">
    <div class="canvas-wrapper" [style.transform]="scaleTransform">
      <svg
        [attr.viewBox]="renderModel.viewBox"
        width="800"
        height="600"
        class="shopfloor-svg"
        xmlns="http://www.w3.org/2000/svg"
      >

        <!-- Render cells -->
        <g class="cells-layer">
          <g
            *ngFor="let cell of renderModel.cells"
            class="cell-group"
            [class.selected]="isCellSelected(cell)"
            (click)="onCellClick(cell)"
            (dblclick)="onCellDoubleClick(cell)"
          >
            <!-- Cell background rectangle -->
            <rect
              [attr.x]="cell.x"
              [attr.y]="cell.y"
              [attr.width]="cell.width"
              [attr.height]="cell.height"
              [attr.fill]="cell.backgroundColor || '#ffffff'"
              class="cell-rect"
              [attr.stroke]="isCellSelected(cell) ? '#ff5722' : '#cccccc'"
              [attr.stroke-width]="isCellSelected(cell) ? 3 : 1"
            />

            <!-- Cell icon (embedded SVG) -->
            <image
              *ngIf="cell.icon"
              [attr.x]="cell.icon.x"
              [attr.y]="cell.icon.y"
              [attr.width]="cell.icon.width"
              [attr.height]="cell.icon.height"
              [attr.href]="cell.icon.svgUrl"
              class="cell-icon"
            />

            <!-- Subcells for compound modules -->
            <g *ngIf="cell.subcells && cell.subcells.length > 0" class="subcells-group">
              <image
                *ngFor="let subcell of cell.subcells"
                [attr.x]="subcell.x"
                [attr.y]="subcell.y"
                [attr.width]="subcell.width"
                [attr.height]="subcell.height"
                [attr.href]="subcell.svgUrl"
                class="subcell-icon"
              />
            </g>

            <!-- Cell label -->
            <text
              *ngIf="cell.label"
              [attr.x]="cell.x + cell.width / 2"
              [attr.y]="cell.y + cell.height - 10"
              class="cell-label"
              text-anchor="middle"
            >
              {{ cell.label }}
            </text>
          </g>
        </g>

        <!-- Render routes (roads) on top of cells -->
        <g class="routes-layer">
          <g *ngFor="let route of renderModel.routes">
            <polyline
              [attr.points]="getPolylinePoints(route.points)"
              class="route-line"
            />
            <!-- FTS icon at midpoint of route -->
            <image
              *ngIf="route.points.length >= 2"
              [attr.x]="(route.points[0][0] + route.points[route.points.length - 1][0]) / 2 - 12"
              [attr.y]="(route.points[0][1] + route.points[route.points.length - 1][1]) / 2 - 12"
              width="24"
              height="24"
              href="/shopfloor/ic_ft_fts.svg"
              class="fts-icon"
            />
          </g>
        </g>

        <!-- Inset highlight for selected cell -->
        <g *ngIf="selectedCellId" class="highlight-layer">
          <rect
            *ngFor="let cell of renderModel.cells"
            [class.hidden]="!isCellSelected(cell)"
            [attr.x]="cell.x + 5"
            [attr.y]="cell.y + 5"
            [attr.width]="cell.width - 10"
            [attr.height]="cell.height - 10"
            class="inset-highlight"
          />
        </g>
      </svg>
    </div>
  </div>

  <footer class="demo-footer">
    <div *ngIf="selectedCellId" class="selection-info">
      <strong>Selected:</strong> {{ selectedCellId }}
    </div>
    <div class="instructions">
      <p>
        <strong>Click</strong> a cell to select/deselect.
        <strong>Double-click</strong> to view details.
      </p>
    </div>
  </footer>
</div>
