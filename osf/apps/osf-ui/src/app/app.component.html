<div
  class="app-frame"
  *ngIf="environment$ | async as currentEnvironment; else loading"
  [class.app-frame--collapsed]="sidebarCollapsed"
>
  <aside class="app-sidebar" [class.app-sidebar--collapsed]="sidebarCollapsed">
    <button type="button" class="sidebar__toggle" (click)="toggleSidebar()">
      <span *ngIf="!sidebarCollapsed" aria-hidden="true">⟨</span>
      <span *ngIf="sidebarCollapsed" aria-hidden="true">⟩</span>
      <span class="sr-only" i18n="@@sidebarToggleLabel">Toggle sidebar</span>
    </button>

    <div class="sidebar__logo" *ngIf="!sidebarCollapsed">
      <img [src]="orbitLogoPath" alt="ORBIS" />
    </div>

    <div class="sidebar__controls" *ngIf="!sidebarCollapsed">
      <section class="control-group">
        <h3 i18n="@@sidebarEnvironmentHeading">Environment</h3>
        <select [(ngModel)]="selectedEnvironment" (ngModelChange)="setEnvironment($event)">
          <option *ngFor="let environment of environments" [value]="environment.key">
            {{ environment.label }}
          </option>
        </select>
        <p class="control-description">{{ currentEnvironment.description }}</p>
      </section>

      <section class="control-group">
        <h3 i18n="@@sidebarRoleHeading">Role</h3>
        <select [(ngModel)]="selectedRole" (ngModelChange)="setRole($event)">
          <option *ngFor="let option of roleOptions" [value]="option.key">
            {{ option.label }}
          </option>
        </select>
      </section>

      <section class="control-group">
        <h3 i18n="@@sidebarLanguageHeading">Language</h3>
        <div class="language-buttons">
          <button
            *ngFor="let locale of locales"
            type="button"
            [class.active]="locale === selectedLocale"
            (click)="changeLanguage(locale)"
          >
            {{ languageLabels[locale] }}
          </button>
        </div>
      </section>

      <section class="control-group">
        <h3>{{ mqttStatusLabel }}</h3>
        <div 
          class="status-pill" 
          [class.status-pill--mock]="currentEnvironment.key === 'mock'"
          [class.status-pill--connected]="(connectionState$ | async) === 'connected'"
          [class.status-pill--disconnected]="(connectionState$ | async) === 'disconnected'"
        >
          {{ currentEnvironment.key === 'mock' 
            ? mqttStatusSimulated 
            : connectionStatusLabels[(connectionState$ | async) ?? 'disconnected'] }}
        </div>
        <button
          *ngIf="(connectionState$ | async) !== 'connected' && currentEnvironment.key !== 'mock'"
          type="button"
          class="sidebar-connect-btn"
          (click)="manualConnect()"
          [disabled]="(connectionState$ | async) === 'connecting'"
          [attr.aria-label]="connectButtonLabel"
          i18n-aria-label="@@sidebarConnectButtonAriaLabel"
        >
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="8" y="2" width="8" height="12" rx="1" />
            <path d="M10 6h4M10 10h4" />
            <path d="M12 14v6M9 18h6" />
          </svg>
          <span i18n="@@sidebarConnectButtonLabel">Connect</span>
        </button>
      </section>

      <section class="control-group sidebar__version" *ngIf="!sidebarCollapsed">
        <p class="version-info">
          <span class="version-label">OSF Dashboard</span>
          <span class="version-number"> v{{ version.full }}</span>
        </p>
      </section>
    </div>
  </aside>

  <div class="app-main">
    <header class="app-header">
      <div class="header__title">
        <img [src]="orbitLogoPath" alt="ORBIS" />
        <div>
          <h1>{{ headerTitle }}</h1>
          <p>{{ headerSubtitle }}</p>
        </div>
      </div>
      <div class="header__actions">
        <div class="connection-status">
          <span 
            class="status-label"
            [class.status-label--connected]="(connectionState$ | async) === 'connected'"
            [class.status-label--disconnected]="(connectionState$ | async) === 'disconnected'"
            [class.status-label--connecting]="(connectionState$ | async) === 'connecting'"
            [class.status-label--error]="(connectionState$ | async) === 'error'"
          >
            {{ connectionStatusLabels[(connectionState$ | async) ?? 'disconnected'] }}
          </span>
          <ng-container *ngIf="currentError as error">
            <span class="status-error">{{ error }}</span>
          </ng-container>
        </div>
        <button
          *ngIf="(connectionState$ | async) !== 'connected' && (environment$ | async)?.key !== 'mock'"
          type="button"
          class="connect-btn"
          (click)="manualConnect()"
          [disabled]="(connectionState$ | async) === 'connecting'"
          [attr.aria-label]="connectButtonLabel"
          i18n-aria-label="@@headerConnectButtonAriaLabel"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="8" y="2" width="8" height="12" rx="1" />
            <path d="M10 6h4M10 10h4" />
            <path d="M12 14v6M9 18h6" />
          </svg>
          <span i18n="@@headerConnectButtonLabel">Connect</span>
        </button>
        <button type="button" class="reset-btn" (click)="resetFactory()">
          {{ resetLabel }}
        </button>
      </div>
    </header>

    <nav class="app-nav" aria-label="Main navigation" i18n-aria-label="@@appNavAriaLabel">
      <a
        *ngFor="let item of navigation; trackBy: trackNav"
        [routerLink]="getRouteWithLocale(item.route)"
        routerLinkActive="active"
        [routerLinkActiveOptions]="{ exact: true }"
        [class.hidden]="!isNavVisible(item, (role$ | async) ?? null)"
      >
        <span>{{ item.label }}</span>
      </a>
    </nav>

    <main class="app-content">
      <router-outlet />
    </main>
  </div>
</div>

<ng-template #loading>
  <div class="app-loading" i18n="@@appLoading">Loading…</div>
</ng-template>
