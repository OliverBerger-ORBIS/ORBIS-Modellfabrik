name: Shopfloor Display Tests

on:
  push:
    branches: [ main, develop, 'feature/shopfloor-*' ]
    paths:
      - 'omf2/config/ccu/shopfloor_*.py'
      - 'omf2/config/ccu/shopfloor_layout.json'
      - 'omf2/assets/asset_manager.py'
      - 'omf2/ui/ccu/common/shopfloor_layout.py'
      - 'tests/test_omf2/test_shopfloor_display.py'
      - 'tests/test_omf2/test_asset_manager.py'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'omf2/config/ccu/shopfloor_*.py'
      - 'omf2/config/ccu/shopfloor_layout.json'
      - 'omf2/assets/asset_manager.py'
      - 'omf2/ui/ccu/common/shopfloor_layout.py'
      - 'tests/test_omf2/test_shopfloor_display.py'
      - 'tests/test_omf2/test_asset_manager.py'

jobs:
  test-shopfloor:
    runs-on: ubuntu-latest
    name: Test Shopfloor Display Module
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run shopfloor display tests
      run: |
        echo "🧪 Testing shopfloor display module..."
        python -m pytest tests/test_omf2/test_shopfloor_display.py -v --tb=short
    
    - name: Run asset manager tests
      run: |
        echo "🧪 Testing asset manager (shopfloor-related)..."
        python -m pytest tests/test_omf2/test_asset_manager.py -v --tb=short
    
    - name: Verify no deprecated keys in codebase
      run: |
        echo "🔍 Checking for deprecated COMPANY_square*/SOFTWARE_square* keys..."
        if grep -r "COMPANY_square\|SOFTWARE_square" --include="*.py" --include="*.json" omf2/ tests/ 2>/dev/null | grep -v "# DEPRECATED" | grep -v "deprecated"; then
          echo "❌ Found deprecated keys in code (excluding comments)"
          exit 1
        else
          echo "✅ No deprecated keys found"
        fi
    
    - name: Test summary
      if: always()
      run: |
        echo "📊 Shopfloor Display Test Summary"
        echo "================================="
        echo "✅ Shopfloor display module tests completed"
        echo "✅ Asset manager tests completed"
        echo "✅ Deprecated key check completed"
