<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Subscriber</title>
    
    <!-- Load mqtt.js from CDN -->
    <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
    
    <!-- Load Streamlit component helper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/streamlit-component-lib/1.10.0/streamlit-component-lib.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        #status {
            padding: 2px 6px;
            font-size: 11px;
            color: #666;
            display: none; /* Hidden by default for minimal UI */
        }
        
        .status-connecting { color: #ff9800; }
        .status-connected { color: #4caf50; }
        .status-error { color: #f44336; }
        .status-disconnected { color: #999; }
    </style>
</head>
<body>
    <div id="status">Initializing...</div>
    
    <script>
        (function() {
            'use strict';
            
            // Get component data from Streamlit
            const data = window.frameElement?.dataset || {};
            const brokerUrl = data.args ? JSON.parse(data.args).broker_url : null;
            const topic = data.args ? JSON.parse(data.args).topic : null;
            const clientId = data.args ? JSON.parse(data.args).client_id : 'streamlit_ui_' + Math.random().toString(36).substr(2, 9);
            
            const statusElement = document.getElementById('status');
            let client = null;
            let connected = false;
            
            /**
             * Update status display (hidden by default)
             */
            function updateStatus(message, className) {
                statusElement.textContent = message;
                statusElement.className = className;
                console.log('[MQTT Component]', message);
            }
            
            /**
             * Send message to Streamlit
             */
            function sendToStreamlit(payload) {
                if (typeof Streamlit !== 'undefined' && Streamlit.setComponentValue) {
                    Streamlit.setComponentValue(payload);
                    console.log('[MQTT Component] Sent to Streamlit:', payload);
                } else {
                    console.warn('[MQTT Component] Streamlit API not available');
                }
            }
            
            /**
             * Connect to MQTT broker and subscribe to topic
             */
            function connectMqtt() {
                if (!brokerUrl || !topic) {
                    updateStatus('Missing broker URL or topic', 'status-error');
                    sendToStreamlit(null);
                    return;
                }
                
                try {
                    updateStatus('Connecting...', 'status-connecting');
                    
                    // Create MQTT client
                    client = mqtt.connect(brokerUrl, {
                        clientId: clientId,
                        clean: true,
                        reconnectPeriod: 5000,
                        connectTimeout: 10000,
                    });
                    
                    // Handle connection
                    client.on('connect', function() {
                        connected = true;
                        updateStatus('Connected, subscribing...', 'status-connecting');
                        
                        // Subscribe to topic
                        client.subscribe(topic, { qos: 0 }, function(err) {
                            if (err) {
                                updateStatus('Subscribe failed: ' + err.message, 'status-error');
                                console.error('[MQTT Component] Subscribe error:', err);
                            } else {
                                updateStatus('Subscribed to ' + topic, 'status-connected');
                                // Send initial null to Streamlit to indicate ready
                                sendToStreamlit(null);
                            }
                        });
                    });
                    
                    // Handle incoming messages
                    client.on('message', function(receivedTopic, message) {
                        if (receivedTopic === topic) {
                            try {
                                const payload = JSON.parse(message.toString());
                                console.log('[MQTT Component] Received message:', payload);
                                
                                // Send to Streamlit
                                sendToStreamlit(payload);
                                
                                // Brief visual feedback (optional)
                                updateStatus('Message received', 'status-connected');
                                
                            } catch (parseError) {
                                console.error('[MQTT Component] Failed to parse message:', parseError);
                                updateStatus('Parse error', 'status-error');
                            }
                        }
                    });
                    
                    // Handle errors
                    client.on('error', function(error) {
                        updateStatus('Error: ' + error.message, 'status-error');
                        console.error('[MQTT Component] Connection error:', error);
                        sendToStreamlit(null);
                    });
                    
                    // Handle disconnection
                    client.on('close', function() {
                        connected = false;
                        updateStatus('Disconnected', 'status-disconnected');
                    });
                    
                    // Handle reconnection
                    client.on('reconnect', function() {
                        updateStatus('Reconnecting...', 'status-connecting');
                    });
                    
                } catch (error) {
                    updateStatus('Connection failed: ' + error.message, 'status-error');
                    console.error('[MQTT Component] Fatal error:', error);
                    sendToStreamlit(null);
                }
            }
            
            /**
             * Cleanup on unload
             */
            window.addEventListener('beforeunload', function() {
                if (client && connected) {
                    client.end(true);
                }
            });
            
            // Initialize Streamlit component
            if (typeof Streamlit !== 'undefined') {
                Streamlit.setFrameHeight(0); // Invisible component
                
                // Start connection
                connectMqtt();
            } else {
                console.warn('[MQTT Component] Streamlit API not loaded, retrying...');
                setTimeout(function() {
                    if (typeof Streamlit !== 'undefined') {
                        Streamlit.setFrameHeight(0);
                        connectMqtt();
                    } else {
                        updateStatus('Streamlit API unavailable', 'status-error');
                    }
                }, 500);
            }
            
        })();
    </script>
</body>
</html>
