<div class="route-card card">
  <h3>
    <span class="icon">üó∫Ô∏è</span>
    Route & Position
  </h3>
  
  <div class="shopfloor-map">
    <svg viewBox="0 0 800 600" class="map-svg">
      <!-- Background grid -->
      <defs>
        <pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse">
          <path d="M 100 0 L 0 0 0 100" fill="none" stroke="#e8e8e8" stroke-width="1"/>
        </pattern>
        <!-- Gradient for module boxes -->
        <linearGradient id="moduleGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#f8f9fa;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#e9ecef;stop-opacity:1" />
        </linearGradient>
      </defs>
      <rect width="800" height="600" fill="url(#grid)"/>
      
      <!-- Edges (connections between nodes) -->
      <g class="edges">
        <ng-container *ngFor="let edge of edges">
          <line *ngIf="getEdgeCoords(edge) as coords"
                [attr.x1]="coords.x1" 
                [attr.y1]="coords.y1" 
                [attr.x2]="coords.x2" 
                [attr.y2]="coords.y2" 
                stroke="#cbd5e1" 
                stroke-width="6"
                stroke-linecap="round"/>
        </ng-container>
      </g>
      
      <!-- Module boxes (stations) -->
      <g class="modules">
        <ng-container *ngFor="let node of nodes">
          <g *ngIf="isModule(node.id)"
             [attr.transform]="'translate(' + node.x + ',' + node.y + ')'"
             [class]="getNodeClass(node.id)"
             class="module-node">
            <rect x="-50" y="-35" width="100" height="70" rx="10" 
                  fill="url(#moduleGradient)" 
                  stroke="#94a3b8" 
                  stroke-width="3"
                  class="module-rect"/>
            <text y="8" class="module-label">{{ node.label }}</text>
          </g>
        </ng-container>
      </g>
      
      <!-- Intersection nodes -->
      <g class="intersections">
        <ng-container *ngFor="let node of nodes">
          <g *ngIf="!isModule(node.id)"
             [attr.transform]="'translate(' + node.x + ',' + node.y + ')'"
             [class]="getNodeClass(node.id)"
             class="intersection-node">
            <circle r="28" class="intersection-circle"/>
            <text y="10" class="intersection-label">{{ node.label }}</text>
          </g>
        </ng-container>
      </g>
      
      <!-- FTS Position Indicator -->
      <g *ngIf="currentPosition" 
         [attr.transform]="'translate(' + currentPosition.x + ',' + currentPosition.y + ')'"
         class="fts-indicator"
         [class.driving]="isDriving">
        <circle r="45" class="fts-outer"/>
        <circle r="25" class="fts-inner"/>
        <text y="8" class="fts-icon">üöó</text>
      </g>
    </svg>
    
    <div class="map-legend">
      <div class="legend-item">
        <span class="legend-box module"></span>
        <span>Station</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot intersection"></span>
        <span>Intersection</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot current"></span>
        <span>Current Position</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot driving"></span>
        <span>In Motion</span>
      </div>
    </div>
  </div>
  
  <div class="route-info">
    <div class="info-row">
      <span class="label">Current Node</span>
      <span class="value node-id">{{ currentNodeId || 'Unknown' }}</span>
    </div>
    <div class="info-row">
      <span class="label">Status</span>
      <span class="value" [class.driving]="isDriving">
        {{ isDriving ? 'In Transit' : 'Stationary' }}
      </span>
    </div>
  </div>
  
  <div class="action-timeline" *ngIf="actionStates.length > 0">
    <h4>Action Timeline</h4>
    <div class="timeline">
      <div 
        *ngFor="let action of actionStates; let last = last" 
        class="timeline-item"
        [class]="action.command.toLowerCase()">
        <span class="timeline-time">{{ action.timestamp | date:'HH:mm:ss' }}</span>
        <div class="timeline-content">
          <strong>{{ action.command }}</strong>
          <span class="status-badge small" [class]="getStateClass(action.state)">
            {{ action.state }}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>
