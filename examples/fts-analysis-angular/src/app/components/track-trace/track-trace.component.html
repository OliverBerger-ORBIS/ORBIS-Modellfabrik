<div class="track-trace-card card">
  <h3>
    <span class="icon">üîç</span>
    Track & Trace
  </h3>
  
  <div class="search-section">
    <div class="search-input">
      <input 
        type="text" 
        [(ngModel)]="searchTerm"
        placeholder="Search workpiece ID..."
        class="search-field">
      <button class="clear-btn" *ngIf="searchTerm" (click)="clearSelection()">‚úï</button>
    </div>
  </div>
  
  <div class="workpieces-list" *ngIf="(workpieces$ | async) as workpieces">
    <div class="section-title">Tracked Workpieces ({{ workpieces.length }})</div>
    
    <div class="workpiece-items" *ngIf="workpieces.length > 0">
      <div 
        *ngFor="let wp of workpieces; trackBy: trackByWorkpieceId"
        class="workpiece-item"
        [class.selected]="selectedWorkpieceId === wp.workpieceId"
        [class]="getTypeClass(wp.workpieceType)"
        (click)="selectWorkpiece(wp.workpieceId)">
        
        <div class="workpiece-badge" [class]="getTypeClass(wp.workpieceType)">
          {{ wp.workpieceType }}
        </div>
        
        <div class="workpiece-info">
          <span class="workpiece-id">{{ wp.workpieceId }}</span>
          <span class="workpiece-location">{{ getLocationLabel(wp.currentLocation || '') }}</span>
        </div>
        
        <div class="workpiece-events">
          {{ wp.events.length }} events
        </div>
      </div>
    </div>
    
    <div class="empty-state" *ngIf="workpieces.length === 0">
      <p>No workpieces tracked yet.</p>
      <p class="hint">Workpieces will appear here as they are loaded on the AGV.</p>
    </div>
  </div>
  
  <div class="history-section" *ngIf="selectedWorkpieceId && (selectedHistory$ | async) as history">
    <div class="section-title">
      <span>Event History</span>
      <button class="close-btn" (click)="clearSelection()">‚úï Close</button>
    </div>
    
    <div class="history-header">
      <div class="workpiece-badge large" [class]="getTypeClass(history.workpieceType)">
        {{ history.workpieceType }}
      </div>
      <div class="header-info">
        <span class="id-label">ID:</span>
        <span class="id-value">{{ history.workpieceId }}</span>
      </div>
    </div>
    
    <!-- Order Context Display -->
    <div class="order-context" *ngIf="history.orders && history.orders.length > 0">
      <div class="order-context-title">üìã Order Context</div>
      <div class="orders-list">
        <div *ngFor="let order of history.orders" 
             class="order-card"
             [class.storage]="order.orderType === 'STORAGE'"
             [class.production]="order.orderType === 'PRODUCTION'">
          <div class="order-header">
            <span class="order-type-icon">{{ getOrderTypeIcon(order.orderType) }}</span>
            <span class="order-type-label">{{ getOrderTypeLabel(order.orderType) }}</span>
          </div>
          <div class="order-details">
            <div class="order-field" *ngIf="order.purchaseOrderId">
              <span class="field-label">Purchase Order:</span>
              <span class="field-value erp-id">{{ order.purchaseOrderId }}</span>
            </div>
            <div class="order-field" *ngIf="order.customerOrderId">
              <span class="field-label">Customer Order:</span>
              <span class="field-value erp-id">{{ order.customerOrderId }}</span>
            </div>
            <div class="order-route">
              <span class="route-from">{{ getLocationLabel(order.fromLocation || '') }}</span>
              <span class="route-arrow">‚Üí</span>
              <span class="route-to">{{ getLocationLabel(order.toLocation || '') }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Events grouped by order -->
    <div class="events-by-order">
      <ng-container *ngFor="let group of groupEventsByOrder(history); trackBy: trackByOrder">
        <div class="order-group" 
             [class.storage]="group.order?.orderType === 'STORAGE'"
             [class.production]="group.order?.orderType === 'PRODUCTION'">
          
          <div class="order-group-header" *ngIf="group.order">
            <span class="order-group-icon">{{ getOrderTypeIcon(group.order.orderType) }}</span>
            <span class="order-group-label">{{ getOrderTypeLabel(group.order.orderType) }}</span>
            <span class="order-group-id" *ngIf="group.order.purchaseOrderId">
              {{ group.order.purchaseOrderId }}
            </span>
            <span class="order-group-id" *ngIf="group.order.customerOrderId">
              {{ group.order.customerOrderId }}
            </span>
          </div>
          
          <!-- Station-grouped manufacturing tasks for Production Orders -->
          <div class="station-groups" *ngIf="group.stationGroups && group.stationGroups.length > 0">
            <div 
              *ngFor="let station of group.stationGroups; trackBy: trackByStation"
              class="station-group">
              <div class="station-header">
                <span class="station-icon">{{ getStationIcon(station.stationId) }}</span>
                <span class="station-name">{{ station.stationName }}</span>
                <span class="station-task-count">{{ station.events.length }} tasks</span>
              </div>
              
              <div class="station-tasks">
                <div 
                  *ngFor="let event of station.events; trackBy: trackByEvent"
                  class="task-item"
                  [class]="event.eventType.toLowerCase()">
                  
                  <div class="task-icon">{{ getEventIcon(event.eventType) }}</div>
                  
                  <div class="task-content">
                    <div class="task-header">
                      <span class="task-type">{{ event.eventType }}</span>
                      <span class="task-duration" *ngIf="event.processDuration">
                        {{ formatDuration(event.processDuration) }}
                      </span>
                    </div>
                    <div class="task-time">{{ formatTimestamp(event.timestamp) }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Regular timeline for non-station events (Storage order, transport) -->
          <div class="timeline" *ngIf="!group.stationGroups || group.stationGroups.length === 0">
            <div 
              *ngFor="let event of group.events; trackBy: trackByEvent; let last = last"
              class="timeline-item"
              [class]="event.eventType.toLowerCase()">
              
              <div class="timeline-marker">
                <span class="event-icon">{{ getEventIcon(event.eventType) }}</span>
              </div>
              
              <div class="timeline-content">
                <div class="event-header">
                  <span class="event-type">{{ event.eventType }}</span>
                  <span class="event-time">{{ formatTimestamp(event.timestamp) }}</span>
                </div>
                
                <div class="event-details">
                  <span class="location" *ngIf="event.location">
                    üìç {{ getLocationLabel(event.location) }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
  
  <div class="info-banner" *ngIf="!selectedWorkpieceId">
    <p>
      <strong>üí° Track & Trace</strong>
    </p>
    <p>
      Select a workpiece from the list to view its complete journey through the production process.
      Manufacturing tasks are grouped by station (PICK ‚Üí PROCESS ‚Üí DROP) within Production Orders.
    </p>
  </div>
</div>
